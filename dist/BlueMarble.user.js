// ==UserScript==
// @name         Black Marble
// @namespace    https://github.com/Jaie55/
// @version      0.85.2
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The project icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       Raw Community
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://bluemarble.lol/
// @icon         https://i.imgur.com/qP3QpF9.png
// @updateURL    https://raw.githubusercontent.com/Jaie55/Wplace-BlueMarble/main/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/Jaie55/Wplace-BlueMarble/main/dist/BlueMarble.user.js
// @match        https://wplace.live/*
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      telemetry.thebluecorner.net
// @resource     CSS-BM-File https://raw.githubusercontent.com/Jaie55/Wplace-BlueMarble/main/dist/BlueMarble.user.css
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var t,e,n=t=>{throw TypeError(t)},o=(t,e,o)=>e.has(t)?n("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,o),i=(t,e,o)=>(((t,e)=>{e.has(t)||n("Cannot access private method")})(t,e),o),r=class{constructor(e,n){o(this,t),this.name=e,this.version=n,this.t=null,this.o="bm-o",this.i=null,this.m=null,this.l=[]}p(t){this.t=t}u(){return this.l.length>0&&(this.m=this.l.pop()),this}h(t){t?.appendChild(this.i),this.i=null,this.m=null,this.l=[]}v(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"div",{},n)),this}k(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"p",{},n)),this}$(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"small",{},n)),this}M(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"img",{},n)),this}S(n,o={},r=()=>{}){return r(this,i(this,t,e).call(this,"h"+n,{},o)),this}N(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"hr",{},n)),this}O(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"br",{},n)),this}T(n={},o=()=>{}){const r=i(this,t,e).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const a=i(this,t,e).call(this,"input",{type:"checkbox"},n);return r.insertBefore(a,r.firstChild),this.u(),o(this,r,a),this}C(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"button",{},n)),this}D(n={},o=()=>{}){const r=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${r}`;const a={textContent:"?",className:"bm-D",onclick:()=>{this.G(this.o,r)}};return o(this,i(this,t,e).call(this,"button",a,n)),this}_(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"input",{},n)),this}B(n={},o=()=>{}){const r=n.textContent??"";delete n.textContent;const a=i(this,t,e).call(this,"div"),c=i(this,t,e).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.u();const m=i(this,t,e).call(this,"button",{textContent:r});return this.u(),this.u(),c.setAttribute("tabindex","-1"),c.setAttribute("aria-hidden","true"),m.addEventListener("click",()=>{c.click()}),c.addEventListener("change",()=>{m.style.maxWidth=`${m.offsetWidth}px`,c.files.length>0?m.textContent=c.files[0].name:m.textContent=r}),o(this,a,c,m),this}j(n={},o=()=>{}){return o(this,i(this,t,e).call(this,"textarea",{},n)),this}G(t,e,n=!1){const o=document.getElementById(t.replace(/^#/,""));o&&(o instanceof HTMLInputElement?o.value=e:n?o.textContent=e:o.innerHTML=e)}L(t,e){let n=!1,o=0,i=0,r=null,a=0,c=0,m=0,s=0;if(t=document.querySelector("#"==t?.[0]?t:"#"+t),e=document.querySelector("#"==e?.[0]?e:"#"+e),!t||!e)return void this.I(`Can not drag! ${t?"":"moveMe"} ${t||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const l=()=>{n&&(a===m&&c===s||(a=m,c=s,t.style.transform=`translate(${a}px, ${c}px)`),r=requestAnimationFrame(l))};let d=null;const p=(p,b)=>{n=!0,d=t.getBoundingClientRect(),o=p-d.left,i=b-d.top,t.style.position="fixed",t.style.left="0px",t.style.top="0px",t.style.right="",t.style.willChange="transform",t.style.transform=`translate(${d.left}px, ${d.top}px)`,a=d.left,c=d.top,m=a,s=c,document.body.style.userSelect="none",e.classList.add("dragging"),r&&cancelAnimationFrame(r),r=requestAnimationFrame(l)},b=()=>{n=!1,r&&(cancelAnimationFrame(r),r=null),document.body.style.userSelect="";try{t.style.willChange=""}catch(t){}e.classList.remove("dragging")};e.addEventListener("mousedown",function(t){t.preventDefault(),p(t.clientX,t.clientY)}),e.addEventListener("touchstart",function(t){const e=t?.touches?.[0];e&&(p(e.clientX,e.clientY),t.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(t){n&&d&&(m=t.clientX-o,s=t.clientY-i)},{passive:!0}),document.addEventListener("touchmove",function(t){if(n&&d){const e=t?.touches?.[0];if(!e)return;m=e.clientX-o,s=e.clientY-i,t.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",b),document.addEventListener("touchend",b),document.addEventListener("touchcancel",b)}W(t){(0,console.info)(`${this.name}: ${t}`),this.G(this.o,"Estado: "+t,!0)}I(t){(0,console.error)(`${this.name}: ${t}`),this.G(this.o,"Error: "+t,!0)}};t=new WeakSet,e=function(t,e={},n={}){const o=document.createElement(t);this.i?(this.m?.appendChild(o),this.l.push(this.m),this.m=o):(this.i=o,this.m=o);for(const[t,n]of Object.entries(e))o[t]=n;for(const[t,e]of Object.entries(n))o[t]=e;return o};var a=class{constructor(){this.F=null,this.A=null,this.q="#bm-h"}P(t){return this.A=t,this.F=new MutationObserver(t=>{for(const e of t)for(const t of e.addedNodes)t instanceof HTMLElement&&t.matches?.(this.q)}),this}J(){return this.F}observe(t,e=!1,n=!1){t.observe(this.A,{childList:e,subtree:n})}};function c(...t){(0,console.error)(...t)}function m(t,e){if(0===t)return e[0];let n="";const o=e.length;for(;t>0;)n=e[t%o]+n,t=Math.floor(t/o);return n}function s(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function l(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}var d,p,b,u=[{id:0,premium:!1,name:"Transparent",rgb:[0,0,0]},{id:1,premium:!1,name:"Black",rgb:[0,0,0]},{id:2,premium:!1,name:"Dark Gray",rgb:[60,60,60]},{id:3,premium:!1,name:"Gray",rgb:[120,120,120]},{id:4,premium:!1,name:"Light Gray",rgb:[210,210,210]},{id:5,premium:!1,name:"White",rgb:[255,255,255]},{id:6,premium:!1,name:"Deep Red",rgb:[96,0,24]},{id:7,premium:!1,name:"Red",rgb:[237,28,36]},{id:8,premium:!1,name:"Orange",rgb:[255,127,39]},{id:9,premium:!1,name:"Gold",rgb:[246,170,9]},{id:10,premium:!1,name:"Yellow",rgb:[249,221,59]},{id:11,premium:!1,name:"Light Yellow",rgb:[255,250,188]},{id:12,premium:!1,name:"Dark Green",rgb:[14,185,104]},{id:13,premium:!1,name:"Green",rgb:[19,230,123]},{id:14,premium:!1,name:"Light Green",rgb:[135,255,94]},{id:15,premium:!1,name:"Dark Teal",rgb:[12,129,110]},{id:16,premium:!1,name:"Teal",rgb:[16,174,166]},{id:17,premium:!1,name:"Light Teal",rgb:[19,225,190]},{id:18,premium:!1,name:"Dark Blue",rgb:[40,80,158]},{id:19,premium:!1,name:"Blue",rgb:[64,147,228]},{id:20,premium:!1,name:"Cyan",rgb:[96,247,242]},{id:21,premium:!1,name:"Indigo",rgb:[107,80,246]},{id:22,premium:!1,name:"Light Indigo",rgb:[153,177,251]},{id:23,premium:!1,name:"Dark Purple",rgb:[120,12,153]},{id:24,premium:!1,name:"Purple",rgb:[170,56,185]},{id:25,premium:!1,name:"Light Purple",rgb:[224,159,249]},{id:26,premium:!1,name:"Dark Pink",rgb:[203,0,122]},{id:27,premium:!1,name:"Pink",rgb:[236,31,128]},{id:28,premium:!1,name:"Light Pink",rgb:[243,141,169]},{id:29,premium:!1,name:"Dark Brown",rgb:[104,70,52]},{id:30,premium:!1,name:"Brown",rgb:[149,104,42]},{id:31,premium:!1,name:"Beige",rgb:[248,178,119]},{id:32,premium:!0,name:"Medium Gray",rgb:[170,170,170]},{id:33,premium:!0,name:"Dark Red",rgb:[165,14,30]},{id:34,premium:!0,name:"Light Red",rgb:[250,128,114]},{id:35,premium:!0,name:"Dark Orange",rgb:[228,92,26]},{id:36,premium:!0,name:"Light Tan",rgb:[214,181,148]},{id:37,premium:!0,name:"Dark Goldenrod",rgb:[156,132,49]},{id:38,premium:!0,name:"Goldenrod",rgb:[197,173,49]},{id:39,premium:!0,name:"Light Goldenrod",rgb:[232,212,95]},{id:40,premium:!0,name:"Dark Olive",rgb:[74,107,58]},{id:41,premium:!0,name:"Olive",rgb:[90,148,74]},{id:42,premium:!0,name:"Light Olive",rgb:[132,197,115]},{id:43,premium:!0,name:"Dark Cyan",rgb:[15,121,159]},{id:44,premium:!0,name:"Light Cyan",rgb:[187,250,242]},{id:45,premium:!0,name:"Light Blue",rgb:[125,199,255]},{id:46,premium:!0,name:"Dark Indigo",rgb:[77,49,184]},{id:47,premium:!0,name:"Dark Slate Blue",rgb:[74,66,132]},{id:48,premium:!0,name:"Slate Blue",rgb:[122,113,196]},{id:49,premium:!0,name:"Light Slate Blue",rgb:[181,174,241]},{id:50,premium:!0,name:"Light Brown",rgb:[219,164,99]},{id:51,premium:!0,name:"Dark Beige",rgb:[209,128,81]},{id:52,premium:!0,name:"Light Beige",rgb:[255,197,165]},{id:53,premium:!0,name:"Dark Peach",rgb:[155,82,73]},{id:54,premium:!0,name:"Peach",rgb:[209,128,120]},{id:55,premium:!0,name:"Light Peach",rgb:[250,182,164]},{id:56,premium:!0,name:"Dark Tan",rgb:[123,99,82]},{id:57,premium:!0,name:"Tan",rgb:[156,132,107]},{id:58,premium:!0,name:"Dark Slate",rgb:[51,57,65]},{id:59,premium:!0,name:"Slate",rgb:[109,117,141]},{id:60,premium:!0,name:"Light Slate",rgb:[179,185,209]},{id:61,premium:!0,name:"Dark Stone",rgb:[109,100,63]},{id:62,premium:!0,name:"Stone",rgb:[148,140,107]},{id:63,premium:!0,name:"Light Stone",rgb:[205,197,158]}],h=class{constructor({displayName:t="My template",X:e=0,R:n="",url:o="",file:i=null,coords:r=null,U:a=null,Y:c=1e3}={}){this.displayName=t,this.X=e,this.R=n,this.url=o,this.file=i,this.coords=r,this.U=a,this.Y=c,this.V=0,this.H=0,this.K=0,this.Z={},this.tt=new Set,this.et=null;const m=Array.isArray(u)?u:[];this.nt=new Set(m.filter(t=>"transparent"!==(t?.name||"").toLowerCase()&&Array.isArray(t?.rgb)).map(t=>`${t.rgb[0]},${t.rgb[1]},${t.rgb[2]}`));const s="222,250,206";this.nt.add(s);const l="other";this.nt.add(l),this.ot=new Map(m.filter(t=>Array.isArray(t?.rgb)).map(t=>[`${t.rgb[0]},${t.rgb[1]},${t.rgb[2]}`,{id:t.id,premium:!!t.premium,name:t.name}]));try{const t=m.find(t=>"transparent"===(t?.name||"").toLowerCase());t&&Array.isArray(t.rgb)&&this.ot.set(s,{id:t.id,premium:!!t.premium,name:t.name})}catch(t){}try{this.ot.set(l,{id:"other",premium:!1,name:"Other"})}catch(t){}console.log("Allowed colors for template:",this.nt)}async it(){console.log("Template coordinates:",this.coords);const t=await createImageBitmap(this.file),e=t.width,n=t.height,o=e*n;console.log(`Template pixel analysis - Dimensions: ${e}×${n} = ${o.toLocaleString()} pixels`),this.V=o;try{const o=new OffscreenCanvas(e,n).getContext("2d",{rt:!0});o.imageSmoothingEnabled=!1,o.clearRect(0,0,e,n),o.drawImage(t,0,0);const i=o.getImageData(0,0,e,n).data;let r=0,a=0;const c=new Map;for(let t=0;t<n;t++)for(let n=0;n<e;n++){const o=4*(t*e+n),m=i[o],s=i[o+1],l=i[o+2];if(0===i[o+3])continue;222===m&&250===s&&206===l&&a++;const d=this.nt.has(`${m},${s},${l}`)?`${m},${s},${l}`:"other";r++,c.set(d,(c.get(d)||0)+1)}this.H=r,this.K=a;const m={};for(const[t,e]of c.entries())m[t]={count:e,enabled:!0};this.Z=m}catch(t){this.H=Math.max(0,this.V),this.K=0,console.warn("Failed to compute required/deface counts. Falling back to total pixels.",t)}const i={},r={},a=new OffscreenCanvas(this.Y,this.Y),c=a.getContext("2d",{rt:!0});for(let o=this.coords[3];o<n+this.coords[3];){const m=Math.min(this.Y-o%this.Y,n-(o-this.coords[3]));console.log(`Math.min(${this.Y} - (${o} % ${this.Y}), ${n} - (${o-this.coords[3]}))`);for(let n=this.coords[2];n<e+this.coords[2];){console.log(`Pixel X: ${n}\nPixel Y: ${o}`);const l=Math.min(this.Y-n%this.Y,e-(n-this.coords[2]));console.log(`Math.min(${this.Y} - (${n} % ${this.Y}), ${e} - (${n-this.coords[2]}))`),console.log(`Draw Size X: ${l}\nDraw Size Y: ${m}`);const d=3*l,p=3*m;a.width=d,a.height=p,console.log(`Draw X: ${l}\nDraw Y: ${m}\nCanvas Width: ${d}\nCanvas Height: ${p}`),c.imageSmoothingEnabled=!1,console.log(`Getting X ${n}-${n+l}\nGetting Y ${o}-${o+m}`),c.clearRect(0,0,d,p),c.drawImage(t,n-this.coords[2],o-this.coords[3],l,m,0,0,3*l,3*m);const b=c.getImageData(0,0,d,p);for(let t=0;t<p;t++)for(let e=0;e<d;e++){const n=4*(t*d+e);if(222===b.data[n]&&250===b.data[n+1]&&206===b.data[n+2])(e+t)%2==0?(b.data[n]=0,b.data[n+1]=0,b.data[n+2]=0):(b.data[n]=255,b.data[n+1]=255,b.data[n+2]=255),b.data[n+3]=32;else if(e%3!=1||t%3!=1)b.data[n+3]=0;else{const t=b.data[n],e=b.data[n+1],o=b.data[n+2];this.nt.has(`${t},${e},${o}`)}}console.log(`Shreaded pixels for ${n}, ${o}`,b),c.putImageData(b,0,0);const u=`${(this.coords[0]+Math.floor(n/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(o/1e3)).toString().padStart(4,"0")},${(n%1e3).toString().padStart(3,"0")},${(o%1e3).toString().padStart(3,"0")}`;i[u]=await createImageBitmap(a),this.tt.add(u.split(",").slice(0,2).join(","));const h=await a.convertToBlob(),y=await h.arrayBuffer(),f=Array.from(new Uint8Array(y));r[u]=s(f),console.log(i),n+=l}o+=m}return console.log("Template Tiles: ",i),console.log("Template Tiles Buffers: ",r),{ct:i,st:r}}};d=new WeakSet,p=async function(t=navigator.userAgent){return(t=t||"").includes("OPR/")||t.includes("Opera")?"Opera":t.includes("Edg/")?"Edge":t.includes("Vivaldi")?"Vivaldi":t.includes("YaBrowser")?"Yandex":t.includes("Kiwi")?"Kiwi":t.includes("Brave")?"Brave":t.includes("Firefox/")?"Firefox":t.includes("Chrome/")?"Chrome":t.includes("Safari/")?"Safari":navigator.brave&&"function"==typeof navigator.brave.isBrave&&await navigator.brave.isBrave()?"Brave":"Unknown"},b=function(t=navigator.userAgent){return/Windows NT 11/i.test(t=t||"")?"Windows 11":/Windows NT 10/i.test(t)?"Windows 10":/Windows NT 6\.3/i.test(t)?"Windows 8.1":/Windows NT 6\.2/i.test(t)?"Windows 8":/Windows NT 6\.1/i.test(t)?"Windows 7":/Windows NT 6\.0/i.test(t)?"Windows Vista":/Windows NT 5\.1|Windows XP/i.test(t)?"Windows XP":/Mac OS X 10[_\.]15/i.test(t)?"macOS Catalina":/Mac OS X 10[_\.]14/i.test(t)?"macOS Mojave":/Mac OS X 10[_\.]13/i.test(t)?"macOS High Sierra":/Mac OS X 10[_\.]12/i.test(t)?"macOS Sierra":/Mac OS X 10[_\.]11/i.test(t)?"OS X El Capitan":/Mac OS X 10[_\.]10/i.test(t)?"OS X Yosemite":/Mac OS X 10[_\.]/i.test(t)?"macOS":/Android/i.test(t)?"Android":/iPhone|iPad|iPod/i.test(t)?"iOS":/Linux/i.test(t)?"Linux":"Unknown"};var y=GM_getResourceText("CSS-BM-File");GM_addStyle(y);try{const t=document.createElement("style");t.id="bm-1A",t.textContent="\n    /* High-specificity rule to force white background for the coords badge */\n    html body #bm-25, #bm-A #bm-25, #bm-26 #bm-25 {\n      background: #FFFFFF !important;\n      color: #000000 !important;\n      padding: .25ch .6ch !important;\n      border-radius: 6px !important;\n      border: 1px solid rgba(0,0,0,0.06) !important;\n      box-shadow: none !important;\n    }\n  ",(document.head||document.documentElement).appendChild(t)}catch(t){}var f=document.createElement("link");f.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap",f.rel="preload",f.as="style",f.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(f);var x=document.createElement("link");x.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap",x.rel="stylesheet",document.head?.appendChild(x);var g=document.createElement("style");g.textContent="\n.material-symbols-rounded {\n  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;\n}\n",document.head?.appendChild(g);var w=document.createElement("style");w.textContent="\n#bm-9.bm-1j, #bm-g.bm-1j {\n  max-height: 84px !important; /* roughly 3 rows of items */\n  overflow: hidden !important; /* hide overflow of the container itself */\n}\n#bm-g.bm-1j {\n  max-height: 84px !important;\n  overflow: auto !important; /* keep internal scrollbar for full content */\n}\n",document.head?.appendChild(w);var v=document.createElement("style");v.id="bm-1B",v.textContent="\n.bm-1C, #bm-Z, #bm-27 {\n  display: none !important;\n  visibility: hidden !important;\n}\n/* Hide empty container inside the color list to avoid an empty padded box */\n#bm-28 > div:empty {\n  display: none !important;\n  visibility: hidden !important;\n}\n",document.head?.appendChild(v);var k=document.createElement("style");k.id="bm-1M",k.textContent="\n/* Always show the top3/minimize icon (bm-29) and make it consistent with other header buttons */\n#bm-29, #bm-2a #bm-29, .bm-1V #bm-29 {\n  display: flex !important;\n  visibility: visible !important;\n  align-items: center !important;\n  justify-content: center !important;\n  width: 36px !important;\n  height: 36px !important;\n  min-width: 36px !important;\n  padding: 4px !important;\n  box-sizing: border-box !important;\n}\n",document.head?.appendChild(k);var $="Black Marble",M="0.85.2";!function(t){const e=document.createElement("script");e.setAttribute("bm-E",$),e.setAttribute("bm-B","color: cornflowerblue;"),e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const t=document.currentScript,e=t?.getAttribute("bm-E")||"Blue Marble",n=t?.getAttribute("bm-B")||"",o=new Map;try{console.log(`%c${e}%c: page fetch spy installed`,n,"")}catch(t){}window.addEventListener("message",t=>{const{source:i,endpoint:r,blobID:a,blobData:c,blink:m}=t.data;if("blue-marble"==i&&a&&c&&!r){const t=o.get(a);"function"==typeof t?t(c):console.warn(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",a),o.delete(a)}});const i=window.fetch;window.fetch=async function(...t){const r=await i.apply(this,t),a=r.clone(),c=(t[0]instanceof Request?t[0]?.url:t[0])||"ignore",m=a.headers.get("content-type")||"";if(m.includes("application/json")){try{console.log(`%c${e}%c: Sending JSON message about endpoint "${c}"`,n,"")}catch(t){}a.json().then(t=>{window.postMessage({source:"blue-marble",endpoint:c,jsonData:t},"*")}).catch(()=>{})}else if(m.includes("image/")&&!c.includes("openfreemap")&&!c.includes("maps")){const t=Date.now(),i=await a.blob();try{console.log(`%c${e}%c: Sending IMAGE message about endpoint "${c}"`,n,"")}catch(t){}return new Promise(e=>{const n=crypto.randomUUID();o.set(n,t=>{e(new Response(t,{headers:a.headers,status:a.status,statusText:a.statusText}))}),window.postMessage({source:"blue-marble",endpoint:c,blobID:n,blobData:i,blink:t},"*")}).catch(()=>r)}return r}}),void 0!==a&&new a;var S=new r($,M),N=(new r($,M),new class{constructor(t,e,n){this.name=t,this.version=e,this.i=n,this.lt="1.0.0",this.dt=null,this.bt="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.Y=1e3,this.ut=3,this.ht=null,this.yt="bm-C",this.ft="div#map canvas.maplibregl-canvas",this.xt=[],this.gt=null,this.wt=!0,this.vt=new Map}kt(){if(document.body.contains(this.ht))return this.ht;document.getElementById(this.yt)?.remove();const t=document.querySelector(this.ft);if(!t)return null;const e=document.createElement("canvas");return e.id=this.yt,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=t.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=t.clientWidth*(window.devicePixelRatio||1)+"px",e.height=t.clientHeight*(window.devicePixelRatio||1),e.width=t.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",t.parentElement?.appendChild(e),this.ht=e,e}async $t(){return{Mt:this.name.replace(/\s+/g,""),St:this.version,Nt:this.lt,Ot:{}}}async Tt(t,e,n){this.gt||(this.gt=await this.$t()),this.gt.Ot&&"object"==typeof this.gt.Ot||(this.gt.Ot={}),this.i.W(`Creando plantilla en ${n.join(", ")}...`);let o=0;try{const t=(this.xt||[]).map(t=>Number(t.X||0)).filter(t=>!Number.isNaN(t)),e=Object.keys(this.gt?.Ot||{}).map(t=>{const e=(t||"").toString().split(" ")[0];return Number(e||0)}).filter(t=>!Number.isNaN(t)),n=t.concat(e);o=n.length?Math.max(...n)+1:0}catch(t){o=this.xt&&this.xt.length?this.xt.length:0}const i=new h({displayName:e,X:o,R:m(this.dt||0,this.bt),file:t,coords:n}),{ct:r,st:a}=await i.it(this.Y);i.U=r,i.et=`${i.X} ${i.R}`;try{this.gt.Ot[i.et]={name:i.displayName,coords:n.join(","),enabled:!0,Ct:a,palette:i.Z}}catch(t){console.warn("Failed to assign new template into templatesJSON.templates",t,this.gt),this.gt=await this.$t(),this.gt.Ot[i.et]={name:i.displayName,coords:n.join(","),enabled:!0,Ct:a,palette:i.Z}}i.enabled=!0,this.xt.push(i);const c=(new Intl.NumberFormat).format(i.V);this.i.W(`Plantilla creada en ${n.join(", ")} — píxeles totales: ${c}`);try{const t=document.querySelector("#bm-9");t&&(t.style.display=""),window.postMessage({source:"blue-marble",zt:"bm-b"},"*")}catch(t){}await this.Dt()}async Dt(){"undefined"!=typeof GM&&GM.setValue&&await GM.setValue("bmTemplates",JSON.stringify(this.gt))}async Gt(t){if(!t)return!1;const e=this.xt.findIndex(e=>e&&e.et===t);-1!==e&&this.xt.splice(e,1),this.gt&&this.gt.Ot&&this.gt.Ot[t]&&(delete this.gt.Ot[t],await this.Dt());try{window.postMessage({source:"blue-marble",zt:"bm-R"},"*")}catch(t){}return!0}async _t(){this.gt||(this.gt=await this.$t())}Bt(t){this.wt=!!t}async jt(t,e){if(!this.wt)return t;const n=this.Y*this.ut,o=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0"),i=this.xt.slice().sort((t,e)=>(t.X||0)-(e.X||0));if(!i.some(t=>!!t?.U&&(t.tt&&t.tt.size?t.tt.has(o):Object.keys(t.U||{}).some(t=>t.startsWith(o)))))return t;const r=i.map(t=>{const e=Object.keys(t.U||{}).find(t=>t.startsWith(o));if(!e)return null;const n=e.split(",");return{Lt:t,It:t.U[e],Wt:[n[2],n[3]]}}).filter(Boolean),a=r.length;let c=0,m=0,s=0;const l=await createImageBitmap(t),d=new OffscreenCanvas(n,n),p=d.getContext("2d");p.imageSmoothingEnabled=!1,p.clearRect(0,0,n,n),p.drawImage(l,0,0,n,n);let b=null;try{b=p.getImageData(0,0,n,n).data}catch(t){}for(const t of r){const e=t.Lt,o={It:t.It,Wt:t.Wt};if(!b)break;let i=null;try{const t=o.It.width,r=o.It.height;i=new OffscreenCanvas(t,r);const a=i.getContext("2d",{rt:!0});a.imageSmoothingEnabled=!1,a.clearRect(0,0,t,r),a.drawImage(o.It,0,0);const l=Number(o.Wt[0])*this.ut,d=Number(o.Wt[1])*this.ut,p=e?.Z||{},u=Object.values(p).some(t=>!1===t?.enabled);let h=null;if(u)try{const n=a.getImageData(0,0,t,r),o=n.data;for(let n=0;n<r;n++)for(let i=0;i<t;i++){if(i%this.ut!==1||n%this.ut!==1)continue;const r=4*(n*t+i),a=o[r],c=o[r+1],m=o[r+2];if(o[r+3]<1)continue;const s=e.nt&&e.nt.has(`${a},${c},${m}`)?`${a},${c},${m}`:"other";p[s]&&!1===p[s].enabled&&(o[r+3]=0)}a.putImageData(n,0,0),h=n.data}catch(e){console.warn("color filter failed",e),h=a.getImageData(0,0,t,r).data}else h=a.getImageData(0,0,t,r).data;for(let e=0;e<r;e++)for(let o=0;o<t;o++){if(o%this.ut!==1||e%this.ut!==1)continue;const i=o+l,r=e+d;if(i<0||r<0||i>=n||r>=n)continue;const a=4*(e*t+o),p=h[a],u=h[a+1],y=h[a+2];if(h[a+3]<64){try{const t=this.xt?.[0],e=4*(r*n+i),o=b[e],a=b[e+1],c=b[e+2],s=b[e+3],l=t?.nt?.has(`${o},${a},${c}`)?`${o},${a},${c}`:"other",d=!!t?.nt&&t.nt.has(l);s>=64&&d&&m++}catch(t){}continue}s++;const f=4*(r*n+i),x=b[f],g=b[f+1],w=b[f+2];b[f+3]<64||(x===p&&g===u&&w===y?c++:m++)}}catch(t){console.warn("stats failed",t)}try{void 0!==i&&i?p.drawImage(i,Number(o.Wt[0])*this.ut,Number(o.Wt[1])*this.ut):p.drawImage(o.It,Number(o.Wt[0])*this.ut,Number(o.Wt[1])*this.ut)}catch(t){}}const u=(this.xt||[]).length;if(a>0){this.vt.set(o,{Et:c,required:s,Ft:m});let t=0,e=0,n=0;for(const o of this.vt.values())t+=o.Et||0,e+=o.required||0,n+=o.Ft||0;const i=this.xt.reduce((t,e)=>t+(e.H||e.V||0),0),r=i>0?i:e,l=(new Intl.NumberFormat).format(t),d=(new Intl.NumberFormat).format(r),p=Math.max(0,r-t),b=Math.max(0,t-r),h=n||0,y=(new Intl.NumberFormat).format(p),f=(new Intl.NumberFormat).format(h),x=(new Intl.NumberFormat).format(b);let g=`Mostrando ${a} plantilla${1===a?"":"s"} (de ${u} cargada${1===u?"":"s"}).`;g+=`\nPintados ${l} / ${d} • Faltan ${y} • Incorrectos ${f}`,b>0&&(g+=` • Extra ${x}`),this.i.W(g)}else this.i.W(`Mostrando ${a} plantilla${1===a?"":"s"} (de ${u} cargada${1===u?"":"s"}).`);return await d.convertToBlob({type:"image/png"})}At(t){if(!t||"object"==typeof t&&0===Object.keys(t).length)return;let e=t;try{if(!e.Ot)if(e.qt&&"object"==typeof e.qt)e=Object.assign({},e),e.Ot=e.qt;else{const t=Object.keys(e||{});t.length>0&&t.every(t=>{const n=e[t];return n&&"object"==typeof n&&(n.Ct||n.coords||n.name||n.palette)})&&(e={Mt:this.name.replace(/\s+/g,""),St:this.version,Nt:this.lt,Ot:e})}}catch(t){}try{this.gt=e}catch(t){}try{this.gt.Ot&&"object"==typeof this.gt.Ot||(this.gt.Ot={})}catch(t){}try{if(t.Ot&&Object.keys(t.Ot).length>0)return void this.Pt(t);const e=(t.Mt||"").toString().toLowerCase();if(e.includes("blue")||e.includes("black")||e.includes("marble"))return void this.Pt(t);if(t&&"object"==typeof t&&Object.keys(t).some(t=>t.toLowerCase().includes("templates")||t.toLowerCase().includes("tt")))return void this.Pt(t)}catch(t){console.warn("Template import/migration failed",t)}}async Pt(t){if(!t)return;try{this.gt=t}catch(t){}const e=t.Ot||{};for(const t of Object.keys(e))try{const n=e[t],o=t.split(" "),i=Number(o[0])||0,r=o[1]||"0",a=n.name||`Template ${i||""}`,c=n.Ct||{},m={};let s=0;const d=new Map;for(const t of Object.keys(c))try{const e=l(c[t]),n=new Blob([e],{type:"image/png"}),o=await createImageBitmap(n);m[t]=o;try{const t=o.width,e=o.height,n=new OffscreenCanvas(t,e).getContext("2d",{rt:!0});n.imageSmoothingEnabled=!1,n.clearRect(0,0,t,e),n.drawImage(o,0,0);const i=n.getImageData(0,0,t,e).data;for(let n=0;n<e;n++)for(let e=0;e<t;e++){if(e%this.ut!==1||n%this.ut!==1)continue;const o=4*(n*t+e),r=i[o],a=i[o+1],c=i[o+2];if(i[o+3]<64)continue;if(222===r&&250===a&&206===c)continue;s++;const m=`${r},${a},${c}`;d.set(m,(d.get(m)||0)+1)}}catch(t){console.warn("count failed",t)}}catch(t){console.warn("tile parse failed",t)}const p=new h({displayName:a,X:i||this.xt.length||0,R:r});p.U=m,p.H=s;const b=this.gt?.Ot?.[t]?.palette||{},u={};for(const[t,e]of d.entries())try{const n=b?.[t],o=!n||"boolean"!=typeof n.enabled||n.enabled,i=n&&"number"==typeof n.count?n.count:e;u[t]={count:i,enabled:o}}catch(n){u[t]={count:e,enabled:!0}}p.Z=u,p.et=t;try{const e=this.gt&&this.gt.Ot&&this.gt.Ot[t];p.enabled=!e||void 0===e.enabled||!!e.enabled,this.gt&&this.gt.Ot&&(this.gt.Ot[t].enabled=!!p.enabled)}catch(t){p.enabled=!0}this.xt.push(p)}catch(t){console.warn("template import failed",t)}try{const t=document.querySelector("#bm-9");t&&(t.style.display=""),window.postMessage({source:"blue-marble",zt:"bm-b"},"*")}catch(t){}try{window.postMessage({source:"blue-marble",zt:"bm-R"},"*")}catch(t){}}Jt(){}}($,M,S)),O=new class{constructor(t){o(this,d),this.Xt=t,this.Rt=!1,this.Ut=[],this.Yt=[]}Vt(t,e){if(!t)return;if(t.status&&"2"!=t.status?.toString()[0])return void e.I("You are not logged in!\nCould not fetch userdata.");const n=Number(t.level||0),o=Number(t.pixelsPainted||0),i=Number(t.droplets||0),r=Number.isFinite(n)&&Number.isFinite(o)?Math.ceil(Math.pow(Math.floor(n)*Math.pow(30,.65),1/.65)-o):0;this.Xt.dt=t.id;try{e.G("bm-u",`Usuario: <b>${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(t.name||"-")}</b>`),e.G("bm-p",`Gotas: <b>${(new Intl.NumberFormat).format(i)}</b>`),e.G("bm-i",`Siguiente nivel en <b>${(new Intl.NumberFormat).format(Math.max(0,r))}</b> ${1==r?"píxel":"píxeles"}`)}catch(t){c("Failed to update overlay user info:",t)}}Ht(t){window.addEventListener("message",async e=>{const n=e.data,o=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const i=n.endpoint?.split("?")[0].split("/").filter(t=>t&&isNaN(Number(t))).filter(t=>t&&!t.includes(".")).pop();switch(console.log('%cBlue Marble%c: Recieved message about "%s"',"color: cornflowerblue;","",i),i){case"me":try{this.Vt(o,t)}catch(e){t.I("Failed to parse userdata")}break;case"pixel":const e=n.endpoint.split("?")[0].split("/").filter(t=>t&&!isNaN(Number(t))),i=new URLSearchParams(n.endpoint.split("?")[1]),c=[i.get("x"),i.get("y")];if(this.Ut.length&&(!e.length||!c.length))return void t.I("Coordinates are malformed!\nDid you try clicking the canvas first?");this.Ut=[...e,...c];const m=(r=e,a=c,[parseInt(r[0])%4*1e3+parseInt(a[0]),parseInt(r[1])%4*1e3+parseInt(a[1])]),s=document.querySelectorAll("span");for(const t of s)if(t.textContent.trim().includes(`${m[0]}, ${m[1]}`)){let n=document.querySelector("#bm-h");const o=`(Tl X: ${e[0]}, Tl Y: ${e[1]}, Px X: ${c[0]}, Px Y: ${c[1]})`;if(n)n.textContent=o;else{const e=document.createElement("span");e.id="bm-h",e.textContent=o,e.setAttribute("data-bm-1Q","1"),e.style.marginLeft="calc(var(--spacing)*3)",e.style.fontSize="small",e.style.padding=".25ch .6ch",e.style.borderRadius="6px",e.style.border="1px solid rgba(0,0,0,0.06)",e.style.mixBlendMode="normal",e.style.backgroundBlendMode="normal",e.style.isolation="isolate",e.style.backdropFilter="none",e.style.filter="none",e.style.opacity="1",e.style.backgroundImage="none",e.style.setProperty("background-color","#ffffff","important"),e.style.setProperty("color","#000000","important");const n=document.querySelector("#bm-h");n?n.replaceWith(e):t.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",e)}}break;case"tiles":let l=n.endpoint.split("/");l=[parseInt(l[l.length-2]),parseInt(l[l.length-1].replace(".png",""))];const d=n.blobID,p=n.blobData,b=await this.Xt.jt(p,l);window.postMessage({source:"blue-marble",blobID:d,blobData:b,blink:n.blink});break;case"robots":this.Rt="false"==o.userscript?.toString().toLowerCase();break}var r,a})}async Kt(t){console.log("Sending heartbeat to telemetry server...");let e=GM_getValue("bmUserSettings","{}");if(e=JSON.parse(e),!e||!e.telemetry||!e.uuid)return void console.log("Telemetry is disabled, not sending heartbeat.");const n=navigator.userAgent;let o=await i(this,d,p).call(this,n),r=i(this,d,b).call(this,n);GM_xmlhttpRequest({method:"POST",url:"https://telemetry.thebluecorner.net/heartbeat",headers:{"Content-Type":"application/json"},data:JSON.stringify({uuid:e.uuid,version:t,browser:o,os:r}),onload:t=>{200!==t.status&&c("Failed to send heartbeat:",t.statusText)},onerror:t=>{c("Error sending heartbeat:",t)}})}}(N);S.p(O);var T=JSON.parse(GM_getValue("bmTemplates","{}"))||{};console.log(T);try{if(T&&Object.keys(T).length){const t=()=>{try{N.At(T)}catch(t){console.warn("Deferred template import failed",t)}};if("undefined"!=typeof requestIdleCallback)try{requestIdleCallback(t,{timeout:2e3})}catch(e){setTimeout(t,0)}else setTimeout(t,0)}}catch(t){}!function(){try{let t=0;const e=60,n=setInterval(()=>{t++;try{if(((N.xt||[]).length||0)>0||t>=e){try{"function"==typeof window.buildTemplatePresetList&&window.buildTemplatePresetList()}catch(t){}try{window.postMessage({source:"blue-marble",zt:"bm-R"},"*")}catch(t){}clearInterval(n)}}catch(o){t>=e&&clearInterval(n)}},100)}catch(t){}}();var C=JSON.parse(GM_getValue("bmUserSettings","{}"));if(console.log(C),console.log(Object.keys(C).length),0==Object.keys(C).length){const t=crypto.randomUUID();console.log(t),GM.setValue("bmUserSettings",JSON.stringify({uuid:t,telemetry:0}))}if(setInterval(()=>O.Kt(M),18e5),console.log(`Telemetry is ${!(null==C?.telemetry)}`),null==C?.telemetry||C?.telemetry>1){const t=new r($,M);t.p(O),t.v({id:"bm-d",style:"top: 0px; left: 0px; width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; z-index: 9999;"}).v({id:"bm-7",style:"display: flex; flex-direction: column; align-items: center;"}).v({id:"bm-1",style:"margin-top: 10%;"}).S(1,{textContent:`${$} Telemetría`}).u().u().v({id:"bm-e",style:"max-width: 50%; overflow-y: auto; max-height: 80vh;"}).N().u().O().u().v({style:"width: fit-content; margin: auto; text-align: center;"}).C({id:"bm-8",textContent:"Más información"},(t,e)=>{e.onclick=()=>{window.open("https://github.com/Jaie55/Wplace-TelemetryServer#telemetry-data","_blank","noopener noreferrer")}}).u().u().O().u().v({style:"width: fit-content; margin: auto; text-align: center;"}).C({id:"bm-5",textContent:"Activar telemetría",style:"margin-right: 2ch;"},(t,e)=>{e.onclick=()=>{const t=JSON.parse(GM_getValue("bmUserSettings","{}"));t.telemetry=1,GM.setValue("bmUserSettings",JSON.stringify(t));const e=document.getElementById("bm-d");e&&(e.style.display="none")}}).u().C({id:"bm-2",textContent:"Desactivar telemetría"},(t,e)=>{e.onclick=()=>{const t=JSON.parse(GM_getValue("bmUserSettings","{}"));t.telemetry=0,GM.setValue("bmUserSettings",JSON.stringify(t));const e=document.getElementById("bm-d");e&&(e.style.display="none")}}).u().u().O().u().k({textContent:'Recopilamos datos de telemetría anónimos como tu navegador, sistema operativo y versión del script para mejorar la experiencia. Los datos no se comparten a nivel personal ni se venden. Puedes desactivar esto pulsando el botón "Desactivar telemetría". Gracias por apoyar Black Marble.'}).u().k({textContent:'Puedes desactivar la telemetría pulsando el botón "Desactivar telemetría" abajo.'}).u().u().u().h(document.body)}!function(){let t=!1,e={};e=(()=>{try{const e=JSON.parse(GM_getValue("bmCoords","{}"))||{};return(t=e)?{Qt:t.Qt??t.Zt??t.te??void 0,ee:t.ee??t.ne??t.oe??void 0,px:t.px??t.px??void 0,ie:t.ie??t.re??t.ae??void 0}:{Qt:void 0,ee:void 0,px:void 0,ie:void 0}}catch(t){return{}}var t})();const n=()=>{try{const t=(t,e)=>document.querySelector(t)?.value??document.querySelector(e)?.value??"",e=Number(t("#bm-v","#bm-2b")||""),n=Number(t("#bm-w","#bm-2c")||""),o=Number(t("#bm-x","#bm-2d")||""),i=Number(t("#bm-y","#bm-2e")||""),r={Qt:e,ee:n,px:o,ie:i,Zt:e,ne:n,re:i,te:e,oe:n,ae:i};GM.setValue("bmCoords",JSON.stringify(r))}catch(t){}};S.v({id:"bm-A",style:"top: 10px; right: 75px;"}).v({id:"bm-j"}).v({id:"bm-z"}).u().M({alt:"Black Marble Icon - Click to minimize/maximize",src:"https://i.imgur.com/qP3QpF9.png",style:"cursor: pointer;"},(e,n)=>{n.addEventListener("click",()=>{t=!t;const o=document.querySelector("#bm-A"),i=document.querySelector("#bm-j"),r=document.querySelector("#bm-z"),a=document.querySelector("#bm-k"),c=document.querySelector("#bm-q"),m=document.querySelector("#bm-r"),s=document.querySelector("#bm-s"),l=document.querySelector("#bm-l"),d=document.querySelectorAll("#bm-k input");try{if(o){const e=getComputedStyle(o);if(t)o.dataset.ce=o.style.width||e.width||"",o.dataset.me=o.style.maxWidth||e.maxWidth||"",o.dataset.se=o.style.minWidth||e.minWidth||"",o.dataset.le=o.style.padding||e.padding||"",o.dataset.de=o.style.height||e.height||"";else{void 0!==o.dataset.ce?o.style.width=o.dataset.ce||"":o.style.width="",void 0!==o.dataset.me?o.style.maxWidth=o.dataset.me||"":o.style.maxWidth="",void 0!==o.dataset.se?o.style.minWidth=o.dataset.se||"":o.style.minWidth="",void 0!==o.dataset.le?o.style.padding=o.dataset.le||"":o.style.padding="",void 0!==o.dataset.de?o.style.height=o.dataset.de||"":o.style.height="";try{delete o.dataset.ce,delete o.dataset.me,delete o.dataset.se,delete o.dataset.le,delete o.dataset.de}catch(t){}}}}catch(t){}if(["#bm-A h1","#bm-f","#bm-A hr","#bm-c > *:not(#bm-k)","#bm-a","#bm-6",`#${e.o}`,"#bm-9"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=t?"none":""})}),t){a&&(a.style.display="none"),c&&(c.style.display="none"),m&&(m.style.display="none"),s&&(s.style.display="none"),l&&(l.style.display="none"),d.forEach(t=>{t.style.display="none"});try{const t=document.querySelector("#bm-29")||document.querySelector("#bm-Z"),e=t?.querySelector(".material-symbols-rounded");if(t&&(t.dataset.active="0"),e){e.textContent="arrow_drop_down";try{e.style.transform="none"}catch(t){}}}catch(t){}try{["#bm-X","#bm-2f","#bm-29","#bm-Z","#bm-2g","#bm-q","#bm-2h","#bm-10"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{t.style.display="none",t.style.visibility="hidden"}catch(t){}})})}catch(t){}try{setTimeout(()=>{const t=document.querySelector("#bm-9");t&&(t.style.display="none")},0)}catch(t){}o.style.width="60px",o.style.height="76px",o.style.padding="8px",n.style.marginLeft="3px",i.style.textAlign="center",i.style.margin="0",i.style.marginBottom="0",r&&(r.style.display="",r.style.marginBottom="0.25em");try{const t=o;if(t){const e=new Set;let o=n;for(;o&&o!==t;)e.add(o),o=o.parentElement;for(o=r;o&&o!==t;)e.add(o),o=o.parentElement;e.add(t),t.querySelectorAll("*").forEach(t=>{try{e.has(t)||(t.style.display="none",t.style.visibility="hidden")}catch(t){}})}}catch(t){}}else{a&&(a.style.display="",a.style.flexDirection="",a.style.justifyContent="",a.style.alignItems="",a.style.gap="",a.style.textAlign="",a.style.margin=""),c&&(c.style.display=""),m&&(m.style.display="",m.style.marginTop=""),s&&(s.style.display="",s.style.marginTop=""),l&&(l.style.display="",l.style.marginTop=""),d.forEach(t=>{t.style.display=""});try{const t=document.querySelector("#bm-29")||document.querySelector("#bm-Z"),e=t?.querySelector(".material-symbols-rounded");if(t&&(t.dataset.active="1"),e){e.textContent="arrow_drop_up";try{e.style.transform="none"}catch(t){}}}catch(t){}try{["#bm-X","#bm-2f","#bm-29","#bm-Z","#bm-2g","#bm-q","#bm-2h","#bm-10"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{t.style.display="",t.style.visibility=""}catch(t){}})})}catch(t){}try{setTimeout(()=>{try{const t=document.querySelector("#bm-9");if(!t)return;N.xt?.length>0&&(t.style.display="")}catch(t){}},0)}catch(t){}n.style.marginLeft="",o.style.padding="10px",i.style.textAlign="",i.style.margin="",i.style.marginBottom="",r&&(r.style.marginBottom="0.5em"),o.style.width="",o.style.height="";try{["#bm-2g","#bm-29","#bm-2h","#bm-q","#bm-Z","#bm-10","#bm-2i","#bm-2j"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{t.style.removeProperty("transform"),t.style.removeProperty("width"),t.style.removeProperty("height"),t.style.removeProperty("min-width"),t.style.removeProperty("padding"),t.style.removeProperty("font-size"),t.style.removeProperty("line-height"),t.style.removeProperty("margin"),t.style.removeProperty("display"),t.style.removeProperty("visibility");try{t.style.boxSizing=""}catch(t){}}catch(t){}})});const t=document.querySelector("#bm-9");if(t){t.style.display="";try{t.style.removeProperty("max-width")}catch(t){}try{t.style.removeProperty("overflow")}catch(t){}const e=document.querySelector("#bm-g");if(e){try{e.style.removeProperty("max-height")}catch(t){}try{e.style.removeProperty("overflow")}catch(t){}try{e.style.width=""}catch(t){}}}const e=document.querySelector("#bm-2a");e&&e.style&&e.style.setProperty&&e.style.setProperty("gap","2px","important"),setTimeout(()=>{try{D()}catch(t){}},20)}catch(t){}try{o&&o.querySelectorAll("*").forEach(t=>{try{t.style.removeProperty("display"),t.style.removeProperty("visibility"),["width","height","min-width","max-width","padding","box-sizing","font-size","line-height","border","border-left","border-right","border-top","border-bottom","border-radius","margin","margin-left","margin-right","transform","align-items","justify-content","minHeight","maxHeight"].forEach(e=>{try{t.style.removeProperty(e)}catch(t){}});try{t.removeAttribute&&t.removeAttribute("data-bm-1K")}catch(t){}}catch(t){}})}catch(t){}}n.alt=t?"Black Marble Icon - Minimized (Click to maximize)":"Black Marble Icon - Maximized (Click to minimize)"})}).u().S(1,{textContent:$}).u().u().v({id:"bm-X",style:"margin-top: 4px; font-size: 12px; color: var(--bm-1P);",textContent:"Plantillas: 0 (0 activas)"}).u()._({type:"hidden",id:"bm-18",value:""}).u().N().u().v({id:"bm-f"}).k({id:"bm-u",textContent:"Usuario: -"}).u().k({id:"bm-p",textContent:"Gotas: -"}).u().k({id:"bm-i",textContent:"Siguiente nivel en -"}).u().u().N().u().v({id:"bm-c"}).v({id:"bm-k"}).C({id:"bm-Z",className:"bm-1C bm-1x",style:"margin-right: 6px; display:flex;"},(t,e)=>{e.dataset.active="0";try{e.style.width="40px",e.style.height="40px",e.style.padding="6px",e.style.minWidth="40px",e.style.boxSizing="border-box",e.style.setProperty&&(e.style.setProperty("width","40px","important"),e.style.setProperty("height","40px","important"),e.style.setProperty("padding","6px","important"),e.style.setProperty("min-width","40px","important"),e.style.setProperty("box-sizing","border-box","important"),e.style.setProperty("display","flex","important"),e.style.setProperty("visibility","visible","important"))}catch(t){}const n=document.createElement("span");n.className="material-symbols-rounded",n.textContent="arrow_drop_up",n.style.fontSize="20px",n.style.display="inline-block",n.style.transition="transform 180ms ease, opacity 120ms ease",e.appendChild(n),e.addEventListener("click",()=>{const t="1"===e.dataset.active;e.dataset.active=t?"0":"1";const o="1"===e.dataset.active,i=document.querySelector("#bm-g");i&&(o?i.classList.add("bm-1j"):i.classList.remove("bm-1j"));try{n.textContent=o?"arrow_drop_down":"arrow_drop_up"}catch(t){}})}).u().C({id:"bm-q",className:"bm-D bm-1u bm-1x",style:"margin-top: 0; display:flex;"},(t,e)=>{e.innerHTML='<span class="material-symbols-rounded">moved_location</span>';try{e.style.width="40px",e.style.height="40px",e.style.padding="6px",e.style.setProperty&&(e.style.setProperty("width","40px","important"),e.style.setProperty("height","40px","important"),e.style.setProperty("padding","6px","important"),e.style.setProperty("min-width","40px","important"),e.style.setProperty("box-sizing","border-box","important"))}catch(t){}e.style.minWidth="40px",e.style.boxSizing="border-box",e.onclick=()=>{const e=t.t,o=t=>{if(Array.isArray(t)||"object"==typeof t&&"number"==typeof t.length)try{return Array.from(t).map(Number).filter(t=>!Number.isNaN(t))}catch(t){}if("string"==typeof t){const e=t.split(/[ ,]+/).map(t=>t.trim()).filter(Boolean).map(Number).filter(t=>!Number.isNaN(t));return e.length?e:null}if("object"==typeof t){const e=["tx","ty","px","py"].map(e=>e in t?Number(t[e]):void 0).filter(t=>void 0!==t&&!Number.isNaN(t));if(4===e.length)return e;const n=[];for(let e=0;e<4;e++)e in t&&n.push(Number(t[e]));if(n.length)return n.filter(t=>!Number.isNaN(t));if(t.coords)return o(t.coords);if(t.toString&&"function"==typeof t.toString){const e=String(t.toString());if(e&&/[, ]/.test(e))return o(e)}}return null};let i=o(e?.Ut)||[];const r=o(e?.Yt)||[];for(let t=0;t<4;t++)(void 0===i[t]||Number.isNaN(Number(i[t])))&&void 0!==r[t]&&null!==r[t]&&""!==r[t]&&(i[t]=Number(r[t]));try{const t=(t=>{if(!t)return[void 0,void 0,void 0,void 0];const e=[[t.Qt,t.ee,t.px,t.ie],[t.Zt,t.ne,t.px,t.re],[t.te,t.oe,t.px,t.ae],[t.Zt,t.ne,t.px,t.re]];for(const t of e)if(t&&t.some(t=>null!=t&&""!==t))return t.map(t=>null!=t&&""!==t?Number(t):void 0);return[void 0,void 0,void 0,void 0]})(JSON.parse(GM_getValue("bmCoords","{}"))||{});for(let e=0;e<4;e++)(void 0===i[e]||Number.isNaN(Number(i[e])))&&void 0!==t[e]&&null!==t[e]&&""!==t[e]&&(i[e]=Number(t[e]))}catch(t){}if(!i||i.length<4||i.slice(0,4).some(t=>void 0===t||Number.isNaN(Number(t)))){if(!Array.isArray(i)||!i.some(t=>null!=t&&!Number.isNaN(Number(t)))){try{const t=o(e?.Ut),n=o(e?.Yt);let r={};try{r=JSON.parse(GM_getValue("bmCoords","{}"))||{}}catch(t){}const a=[r.Qt,r.ee,r.px,r.ie].map(t=>null!=t&&""!==t?Number(t):null);console.warn("Black Marble: coords button failed to assemble 4 values (no numeric candidates)",{coords:i,pe:t,be:n,ue:a})}catch(t){}return void t.I("Coordinates are malformed! Did you try clicking on the canvas first?")}try{console.warn("Black Marble: coords incomplete, padding missing values with 0",{coords:i}),t.W("Coords partially sourced; missing values padded with 0")}catch(t){}for(i=(i||[]).slice(0,4).map(t=>null==t||Number.isNaN(Number(t))?0:Number(t));i.length<4;)i.push(0)}i=i.slice(0,4).map(t=>Number(t)),t.G("bm-v",i[0]??""),t.G("bm-w",i[1]??""),t.G("bm-x",i[2]??""),t.G("bm-y",i[3]??"");try{const t=document.querySelector("#bm-v");t&&(t.value=i[0])}catch(t){}try{const t=document.querySelector("#bm-w");t&&(t.value=i[1])}catch(t){}try{const t=document.querySelector("#bm-x");t&&(t.value=i[2])}catch(t){}try{const t=document.querySelector("#bm-y");t&&(t.value=i[3])}catch(t){}try{const t=document.querySelector("#bm-2b");t&&(t.value=i[0])}catch(t){}try{const t=document.querySelector("#bm-2c");t&&(t.value=i[1])}catch(t){}try{const t=document.querySelector("#bm-2d");t&&(t.value=i[2])}catch(t){}try{const t=document.querySelector("#bm-2e");t&&(t.value=i[3])}catch(t){}n()}}).u().C({id:"bm-10",className:"bm-1E bm-1x",style:"margin-left: 6px; display:flex;"},(t,e)=>{e.dataset.locked="0",e.title="Lock painting to selected colors";try{const t=document.createElement("span");t.className="material-symbols-rounded",t.textContent="lock_open",t.style.fontSize="18px",t.style.display="inline-block",t.style.transition="none",e.appendChild(t),e.style.width="40px",e.style.height="40px",e.style.padding="6px",e.style.minWidth="40px",e.style.boxSizing="border-box",e.style.setProperty&&(e.style.setProperty("width","40px","important"),e.style.setProperty("height","40px","important"),e.style.setProperty("padding","6px","important"),e.style.setProperty("min-width","40px","important"),e.style.setProperty("box-sizing","border-box","important"))}catch(t){}(async()=>{try{if("undefined"!=typeof GM&&"function"==typeof GM.getValue){const t=!!await GM.getValue("bmLocked");e.dataset.locked=t?"1":"0";try{icon.textContent=t?"lock":"lock_open"}catch(t){}}}catch(t){}try{const t=()=>{document.querySelectorAll("#bm-10, #bm-2k, .bm-1E").forEach(t=>{try{t.dataset.locked=e.dataset.locked||"0";const n=t.querySelector&&t.querySelector(".material-symbols-rounded");if(n)try{n.textContent="1"===t.dataset.locked?"lock":"lock_open"}catch(t){}}catch(t){}})};t(),setTimeout(t,120)}catch(t){}})(),e.addEventListener("click",()=>{const t="1"===e.dataset.locked;e.dataset.locked=t?"0":"1";const n="1"===e.dataset.locked,o=e.querySelector(".material-symbols-rounded");if(o){try{o.textContent=n?"lock":"lock_open"}catch(t){}try{o.style.transform="none"}catch(t){}}try{if("undefined"!=typeof GM&&"function"==typeof GM.setValue)try{GM.setValue("bmLocked",n)}catch(t){}}catch(t){}try{document.querySelectorAll("#bm-10, #bm-2k, .bm-1E").forEach(t=>{try{t.dataset.locked=e.dataset.locked;const n=t.querySelector&&t.querySelector(".material-symbols-rounded");if(n)try{n.textContent="1"===t.dataset.locked?"lock":"lock_open"}catch(t){}}catch(t){}})}catch(t){}})}).u()._({type:"number",id:"bm-v",placeholder:"Tl X",min:0,max:2047,step:1,required:!0,value:e.Qt??""},(t,e)=>{try{setTimeout(()=>{try{const t=document.querySelector("#bm-2a");t&&t.style&&t.style.setProperty&&t.style.setProperty("gap","1px","important");const e=document.querySelector("#bm-29")||document.querySelector("#bm-1W")||document.querySelector(".bm-1V")||document.querySelector("#bm-Z"),n=document.querySelector("#bm-2g")||document.querySelector("#bm-1X")||document.querySelector("#bm-q"),o=document.querySelector("#bm-2h")||document.querySelector("#bm-1Y")||document.querySelector("#bm-10"),i=(t,e)=>{t&&t.style&&t.style.setProperty&&(t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("margin","0px","important"),t.style.setProperty("padding","6px","important"),t.style.setProperty("width","34px","important"),t.style.setProperty("height","34px","important"),t.style.setProperty("min-width","34px","important"),t.style.setProperty("box-sizing","border-box","important"),t.style.setProperty("transform","translateX("+e+"px)","important"),t.style.setProperty("vertical-align","middle","important"))};i(e,-6),i(n,-3),i(o,-1)}catch(t){}},60)}catch(t){}e.addEventListener("paste",t=>{let e=(t.clipboardData||window.clipboardData).getData("text").split(" ").filter(t=>t).map(Number).filter(t=>!isNaN(t));if(4!==e.length)return;let n=(o=document,coords=[],coords.push(o.querySelector("#bm-v")),coords.push(o.querySelector("#bm-w")),coords.push(o.querySelector("#bm-x")),coords.push(o.querySelector("#bm-y")),coords);var o;for(let t=0;t<n.length;t++)n[t].value=e[t];t.preventDefault()});const o=()=>n();e.addEventListener("input",o),e.addEventListener("change",o)}).u()._({type:"number",id:"bm-w",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0,value:e.ee??""},(t,e)=>{const o=()=>n();e.addEventListener("input",o),e.addEventListener("change",o)}).u()._({type:"number",id:"bm-x",placeholder:"Px X",min:0,max:2047,step:1,required:!0,value:e.px??""},(t,e)=>{const o=()=>n();e.addEventListener("input",o),e.addEventListener("change",o)}).u()._({type:"number",id:"bm-y",placeholder:"Px Y",min:0,max:2047,step:1,required:!0,value:e.ie??""},(t,e)=>{const o=()=>n();e.addEventListener("input",o),e.addEventListener("change",o)}).u().u().v({id:"bm-9",style:"max-height: 140px; overflow: auto; border: 1px solid rgba(255,255,255,0.1); padding: 4px; border-radius: 4px; display: none;"}).u().v({style:"display: flex; gap: 6px; margin-bottom: 6px;"}).C({id:"bm-3",textContent:"Activar colores",className:"bm-1r bm-1x",style:"font-size: 12px; padding:6px 12px; display: inline-flex; align-items: center; justify-content: center; height: 48px; min-width: 140px; box-sizing: border-box;"},(t,e)=>{e.onclick=()=>{try{const e=document.querySelector("#bm-18")?.value,n=N.xt||[];let o=null;if(e&&(o=n.find(t=>t&&t.et===e)||null),o||(o=n.find(t=>t&&t.selected)||null),!o){const t=N.gt?.Ot||{},e=Object.keys(t).find(e=>t[e]&&t[e].selected);e&&(o=n.find(t=>t&&t.et===e)||null)}if(!o)return void t.I("No hay plantilla seleccionada");if(o.Z){Object.values(o.Z).forEach(t=>{t&&(t.enabled=!0)});try{N.gt?.Ot&&o.et&&(N.gt.Ot[o.et]=N.gt.Ot[o.et]||{},N.gt.Ot[o.et].palette=o.Z,GM.setValue("bmTemplates",JSON.stringify(N.gt)))}catch(t){}}else try{N.gt?.Ot&&o.et&&N.gt.Ot[o.et]?.palette&&(Object.values(N.gt.Ot[o.et].palette).forEach(t=>{t&&(t.enabled=!0)}),GM.setValue("bmTemplates",JSON.stringify(N.gt)))}catch(t){}try{buildColorFilterList()}catch(t){}t.W("Colores habilitados (plantilla seleccionada)"),console.log("BM: enable-all applied to active template",o?.et||"(unknown)")}catch(t){console.error("BM enable-all error",t)}}}).u().C({id:"bm-0",textContent:"Desactivar colores",className:"bm-1r bm-1x",style:"font-size: 12px; padding:6px 12px; display: inline-flex; align-items: center; justify-content: center; height: 48px; min-width: 140px; box-sizing: border-box;"},(t,e)=>{e.onclick=()=>{try{const e=document.querySelector("#bm-18")?.value,n=N.xt||[];let o=null;if(e&&(o=n.find(t=>t&&t.et===e)||null),o||(o=n.find(t=>t&&t.selected)||null),!o){const t=N.gt?.Ot||{},e=Object.keys(t).find(e=>t[e]&&t[e].selected);e&&(o=n.find(t=>t&&t.et===e)||null)}if(!o)return void t.I("No hay plantilla seleccionada");if(o.Z){Object.values(o.Z).forEach(t=>{t&&(t.enabled=!1)});try{N.gt?.Ot&&o.et&&(N.gt.Ot[o.et]=N.gt.Ot[o.et]||{},N.gt.Ot[o.et].palette=o.Z,GM.setValue("bmTemplates",JSON.stringify(N.gt)))}catch(t){}}else try{N.gt?.Ot&&o.et&&N.gt.Ot[o.et]?.palette&&(Object.values(N.gt.Ot[o.et].palette).forEach(t=>{t&&(t.enabled=!1)}),GM.setValue("bmTemplates",JSON.stringify(N.gt)))}catch(t){}try{buildColorFilterList()}catch(t){}t.W("Colores desactivados (plantilla seleccionada)"),console.log("BM: disable-all applied to active template",o?.et||"(unknown)")}catch(t){console.error("BM disable-all error",t)}}}).u().u().v({id:"bm-g"}).u().u().v({id:"bm-15",style:"margin-top:6px; display:block;"}).C({id:"bm-M",textContent:"Gestionar plantillas",className:"bm-1r bm-16",style:"display: flex; width: 100%; box-sizing: border-box; padding: 8px 10px; align-items: center; justify-content: center; margin: 0;"},(t,e)=>{let n=null;e.addEventListener("click",()=>{const o=(()=>{if(n)return n;n=document.createElement("div"),n.id="bm-P",n.style.display="none",n.style.marginTop="8px",n.style.maxHeight="320px",n.style.overflow="auto",n.style.border="1px solid rgba(255,255,255,0.06)",n.style.padding="8px";const o=document.createElement("div");o.style.display="flex",o.style.gap="8px",o.style.alignItems="center";const i=document.createElement("input");i.type="file",i.id="bm-a",i.multiple=!0,i.accept="image/png, image/jpeg, image/webp, image/bmp, image/gif",i.style.display="inline-block";let r=[];const a=document.createElement("button");a.className="btn btn-soft",a.title="Seleccionar plantilla",a.innerHTML='<span class="material-symbols-rounded">upload_file</span>';try{a.style.setProperty("display","inline-flex","important"),a.style.setProperty("visibility","visible","important"),a.style.setProperty("flex","1 1 0","important"),a.style.setProperty("min-width","0","important"),a.style.setProperty("box-sizing","border-box","important"),a.style.setProperty("padding","6px 12px","important"),a.style.setProperty("font-size","12px","important"),a.style.setProperty("height","40px","important"),a.style.setProperty("align-items","center","important"),a.style.setProperty("justify-content","center","important"),a.style.setProperty("white-space","nowrap","important"),a.style.setProperty("overflow","hidden","important"),a.style.setProperty("text-overflow","ellipsis","important")}catch(t){}a.onclick=()=>{try{i.click()}catch(t){console.error(t)}};const c=document.createElement("button");c.className="btn btn-soft bm-1e",c.textContent="Subir",c.style.display="none",c.style.marginLeft="6px";try{c.style.setProperty("display","inline-flex","important"),c.style.setProperty("visibility","visible","important"),c.style.setProperty("flex","1 1 0","important"),c.style.setProperty("min-width","0","important"),c.style.setProperty("box-sizing","border-box","important"),c.style.setProperty("padding","6px 12px","important"),c.style.setProperty("font-size","12px","important"),c.style.setProperty("height","40px","important"),c.style.setProperty("align-items","center","important"),c.style.setProperty("justify-content","center","important")}catch(t){}c.addEventListener("click",()=>{try{(async()=>{try{const e=document.querySelector("#bm-v"),n=document.querySelector("#bm-w"),o=document.querySelector("#bm-x"),c=document.querySelector("#bm-y");if(!(e?.checkValidity()&&n?.checkValidity()&&o?.checkValidity()&&c?.checkValidity()))return t.I("Coordinates are malformed! Select valid coordinates before creating the template.");const m=r||[];if(!m.length)return t.I("No file staged! Use the file picker first.");let s=0;for(const t of m)try{await N.Tt(t,t.name.replace(/\.[^/.]+$/,""),[Number(e.value),Number(n.value),Number(o.value),Number(c.value)]),s++}catch(e){console.error("Failed to create template for",t,e)}if(s){t.W(`Creada(s) ${s} plantilla(s)`),r=[];try{i.value=""}catch(t){}a.title="Seleccionar plantilla";try{window.postMessage({source:"blue-marble",zt:"bm-R"},"*")}catch(t){}try{"function"==typeof window.buildTemplatePresetList&&window.buildTemplatePresetList()}catch(t){}try{"function"==typeof window.buildColorFilterList&&window.buildColorFilterList()}catch(t){}try{setTimeout(()=>{const t=document.getElementById("bm-1s");t&&(t.scrollTop=t.scrollHeight)},80)}catch(t){}try{setTimeout(()=>{try{"function"==typeof window.buildTemplatePresetList&&window.buildTemplatePresetList(),"function"==typeof window.buildColorFilterList&&window.buildColorFilterList();const t=document.getElementById("bm-1s");t&&(t.scrollTop=t.scrollHeight)}catch(t){}},350)}catch(t){}}else t.I("No se creó ninguna plantilla")}catch(e){console.error("Failed to upload template",e),t.I("Error al subir plantilla")}})()}catch(t){}}),i.addEventListener("change",()=>{try{if(r=Array.from(i.files||[]),r.length){const t=r[0].name.replace(/\.[^/.]+$/,""),e=r.length>1?`${t} (+${r.length-1})`:t;a.textContent=e,a.title=`${r.length} archivo(s) seleccionados`,c.style.display="";try{a.style.setProperty("white-space","nowrap","important"),a.style.setProperty("overflow","hidden","important"),a.style.setProperty("text-overflow","ellipsis","important")}catch(t){}}else{a.innerHTML='<span class="material-symbols-rounded">upload_file</span>',a.title="Seleccionar archivo(s)",c.style.display="none";try{a.style.removeProperty("white-space"),a.style.removeProperty("overflow"),a.style.removeProperty("text-overflow")}catch(t){}}}catch(t){}}),o.appendChild(i),o.appendChild(a),o.appendChild(c),n.appendChild(o);const m=document.createElement("div");m.id="bm-1s",m.style.marginTop="12px",m.style.display="block",n.appendChild(m);try{Array.from(document.querySelectorAll("#bm-1s")).forEach(t=>{if(t!==m){for(;t.firstChild;)m.appendChild(t.firstChild);t.remove()}})}catch(t){}return e.parentElement?.insertBefore(n,e.nextSibling),n})();o.style.display="none"===o.style.display?"":"none";try{window.postMessage({source:"blue-marble",zt:"bm-R"},"*")}catch(t){}})}).u().u().j({id:S.o,placeholder:`Estado: Inactivo...\nVersión: ${M}`,readOnly:!0}).u().v({id:"bm-6"}).v().C({id:"bm-m",className:"bm-D bm-1y",innerHTML:'<span class="material-symbols-rounded">palette</span>',title:"Template Color Converter"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).u().C({id:"bm-U",className:"bm-D",innerHTML:'<span class="material-symbols-rounded">bottom_panel_close</span>',title:"Mostrar/ocultar área de estado"},(t,e)=>{e.dataset.active="0";const n=()=>document.querySelector("#bm-2l")||document.querySelector(`#${t.o}`)||document.querySelector("#bm-o");try{"undefined"!=typeof GM&&"function"==typeof GM.getValue&&GM.getValue("bmOutputVisible").then(t=>{try{const o=n();if(o)if(t){o.style.display="",o.dataset.he="0",o.readOnly=!0;try{o.disabled=!1}catch(t){}o.style.opacity="0.9",e.dataset.active="1",e.title="Ocultar área de estado";try{e.innerHTML='<span class="material-symbols-rounded">bottom_panel_open</span>'}catch(t){}}else{o.style.display="none",o.dataset.he="1",o.readOnly=!0;try{o.disabled=!0}catch(t){}o.style.opacity="0.7",e.dataset.active="0",e.title="Mostrar área de estado";try{e.innerHTML='<span class="material-symbols-rounded">bottom_panel_close</span>'}catch(t){}}}catch(t){}}).catch(()=>{})}catch(t){}e.addEventListener("click",()=>{try{const o=n();if(!o){try{t.I("No se encontró el área de estado")}catch(t){}return}if("none"===o.style.display||o.hidden||"1"===o.dataset.he){o.style.display="",o.dataset.he="0",o.readOnly=!0;try{o.disabled=!1}catch(t){}o.style.opacity="0.9",e.dataset.active="1",e.title="Ocultar área de estado";try{e.innerHTML='<span class="material-symbols-rounded">bottom_panel_open</span>'}catch(t){}try{"undefined"!=typeof GM&&"function"==typeof GM.setValue&&GM.setValue("bmOutputVisible",!0)}catch(t){}try{t.W("Área de estado mostrada (solo lectura)")}catch(t){}}else{o.style.display="none",o.dataset.he="1",o.readOnly=!0;try{o.disabled=!0}catch(t){}o.style.opacity="0.7",e.dataset.active="0",e.title="Mostrar área de estado";try{e.innerHTML='<span class="material-symbols-rounded">bottom_panel_close</span>'}catch(t){}try{"undefined"!=typeof GM&&"function"==typeof GM.setValue&&GM.setValue("bmOutputVisible",!1)}catch(t){}try{t.W("Área de estado ocultada")}catch(t){}}}catch(e){try{t.I("Error alternando área de estado")}catch(t){}}})}).u().u().$({textContent:"Creado por SwingTheVine • mod. Jaie55",style:"margin-top: auto; font-size: 9px;"}).u().u().u().h(document.body);try{setTimeout(()=>{const t=document.getElementById("bm-1Z");if(!t)return;Array.from(t.querySelectorAll(":scope > div")).forEach(t=>{try{t.style.setProperty("display","flex","important"),t.style.setProperty("flex-wrap","wrap","important"),t.style.setProperty("gap","6px","important"),t.style.setProperty("align-items","center","important")}catch(t){}});const e=document.getElementById("bm-3"),n=document.getElementById("bm-0"),o=(t,e)=>{try{const n=window.getComputedStyle(t);["padding","font-size","height","min-width","max-width","line-height","box-sizing"].forEach(t=>{const o=n.getPropertyValue(t);o&&e.style.setProperty(t,o,"important")}),e.style.setProperty("white-space","nowrap","important"),e.style.setProperty("overflow","hidden","important"),e.style.setProperty("text-overflow","ellipsis","important")}catch(t){}},i=Array.from(t.querySelectorAll(".btn.btn-soft"));(e||n)&&i.length>0?i.forEach((t,i)=>{try{0===i&&e?o(e,t):1===i&&n?o(n,t):(t.style.setProperty("padding","3px 6px","important"),t.style.setProperty("font-size","11px","important"),t.style.setProperty("height","34px","important"),t.style.setProperty("min-width","40px","important"),t.style.setProperty("max-width","88px","important"),t.style.setProperty("white-space","nowrap","important"),t.style.setProperty("overflow","hidden","important"),t.style.setProperty("text-overflow","ellipsis","important"),t.style.setProperty("box-sizing","border-box","important"))}catch(t){}}):i.forEach(t=>{try{t.style.setProperty("padding","3px 6px","important"),t.style.setProperty("font-size","11px","important"),t.style.setProperty("height","34px","important"),t.style.setProperty("min-width","40px","important"),t.style.setProperty("max-width","88px","important"),t.style.setProperty("white-space","nowrap","important"),t.style.setProperty("overflow","hidden","important"),t.style.setProperty("text-overflow","ellipsis","important"),t.style.setProperty("box-sizing","border-box","important")}catch(t){}})},120)}catch(t){}try{setTimeout(()=>{const t=document.querySelector("#bm-v")?.value??document.querySelector("#bm-2b")?.value,e=document.querySelector("#bm-w")?.value??document.querySelector("#bm-2c")?.value,n=document.querySelector("#bm-x")?.value??document.querySelector("#bm-2d")?.value,o=document.querySelector("#bm-y")?.value??document.querySelector("#bm-2e")?.value;document.querySelector("#bm-2b")&&(document.querySelector("#bm-2b").value=t??""),document.querySelector("#bm-2c")&&(document.querySelector("#bm-2c").value=e??""),document.querySelector("#bm-2d")&&(document.querySelector("#bm-2d").value=n??""),document.querySelector("#bm-2e")&&(document.querySelector("#bm-2e").value=o??"")},50)}catch(t){}try{setTimeout(()=>{try{const t=document.querySelector("#bm-9"),e=document.querySelector("#bm-g");t&&!t.classList.contains("bm-1j")&&t.classList.add("bm-1j"),e&&!e.classList.contains("bm-1j")&&e.classList.add("bm-1j");try{const t=document.querySelector("#bm-Z")||document.querySelector("#bm-29");if(t){t.dataset.active="1";const e=t.querySelector(".material-symbols-rounded");e&&(e.textContent="arrow_drop_down")}}catch(t){}try{const t=document.querySelector("#bm-2m")||document.querySelector("#bm-z");if(t&&!t.querySelector("#bm-1g")){const e=document.createElement("div");e.id="bm-1g",e.style.pointerEvents="none",e.style.position="absolute",e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)",e.style.width="46%",e.style.height="6px",e.style.borderRadius="4px",e.style.background="linear-gradient(90deg, var(--bm-1P, #FA4E49), rgba(250,78,73,0.9))",e.style.boxShadow="0 1px 0 rgba(0,0,0,0.45) inset, 0 0 10px rgba(250,78,73,0.06)",e.style.zIndex="2",t.style.position=t.style.position||"relative",t.appendChild(e)}}catch(t){}}catch(t){}},0)}catch(t){}try{setTimeout(()=>{try{const t=document.getElementById("bm-15"),e=document.getElementById("bm-g"),n=document.getElementById("bm-2n");if(t){n&&n.parentElement&&t.parentElement!==n.parentElement?n.parentElement.insertBefore(t,n.nextSibling):e&&e.parentElement&&t.parentElement!==e.parentElement&&e.parentElement.insertBefore(t,e.nextSibling);try{t.style.setProperty("display","block","important")}catch(t){}try{t.style.setProperty("width","100%","important")}catch(t){}try{t.style.setProperty("box-sizing","border-box","important")}catch(t){}try{t.style.setProperty("margin-top","8px","important")}catch(t){}try{t.style.setProperty("clear","both","important")}catch(t){}try{t.style.setProperty("z-index","1","important")}catch(t){}}const o=document.getElementById("bm-M");if(o){o.classList.add("bm-16");try{o.style.setProperty("display","flex","important")}catch(t){}try{o.style.setProperty("width","88%","important")}catch(t){}try{o.style.setProperty("max-width","420px","important")}catch(t){}try{o.style.setProperty("margin","0 auto","important")}catch(t){}try{o.style.setProperty("box-sizing","border-box","important")}catch(t){}try{o.style.setProperty("padding","8px 10px","important")}catch(t){}try{o.style.setProperty("margin-top","6px","important")}catch(t){}try{o.style.removeProperty("background")}catch(t){}try{o.style.removeProperty("color")}catch(t){}try{o.style.removeProperty("border")}catch(t){}try{o.style.setProperty("position","relative","important")}catch(t){}try{o.style.removeProperty("transform")}catch(t){}}}catch(t){}},60)}catch(t){}window.buildColorFilterList=function(){const t=document.querySelector("#bm-g"),e=document.querySelector("#bm-18")?.value,n=e||document.querySelector("#bm-1h")?.value,o=N.xt?.find(t=>t.et===n)||N.xt?.[0];try{if(o&&(!o.Z||0===Object.keys(o.Z).length)){const t=N.gt?.Ot?.[o.et]?.palette;t&&Object.keys(t).length>0&&(o.Z=t)}}catch(t){}try{const t=N.gt?.Ot?.[o?.et]?.palette;if(t&&o){o.Z=o.Z||{};for(const[e,n]of Object.entries(t))try{const t=o.Z[e]||{};o.Z[e]={count:t.count||n.count||0,enabled:"boolean"==typeof n.enabled?n.enabled:"boolean"!=typeof t.enabled||t.enabled}}catch(t){}}}catch(t){}if(!t||!o?.Z)return void(t&&(t.innerHTML="<small>No hay colores de plantilla para mostrar.</small>"));t.innerHTML="";try{t.style.setProperty("width","100%","important"),t.style.setProperty("box-sizing","border-box","important");const e=document.querySelector("#bm-9");e&&(e.style.setProperty("width","100%","important"),e.style.setProperty("box-sizing","border-box","important"));const n=document.querySelector("#bm-g");n&&(n.style.setProperty("width","100%","important"),n.style.setProperty("box-sizing","border-box","important"))}catch(t){}const i=Object.entries(o.Z).sort((t,e)=>e[1].count-t[1].count),r=document.querySelector("#bm-Q");r&&r.dataset&&r.dataset.active;for(const[e,n]of i){let o=document.createElement("div");o.style.display="flex",o.style.flexWrap="wrap",o.style.alignItems="center",o.style.gap="8px",o.style.margin="4px 0";let i=document.createElement("div");i.style.width="14px",i.style.height="14px",i.style.border="1px solid rgba(255,255,255,0.5)";let r=document.createElement("span");r.style.fontSize="12px";let a=`${n.count.toLocaleString()}`;if("other"===e)i.style.background="#888",a=`Other • ${a}`;else if("#deface"===e)i.style.background="#deface",a=`Transparent • ${a}`;else{const[t,n,o]=e.split(",").map(Number);i.style.background=`rgb(${t},${n},${o})`;try{const i=document.querySelector("#bm-1h")?.value,r=N.xt?.find(t=>t.et===i)||N.xt?.[0],c=r?.ot?.get(e);if(c&&"number"==typeof c.id){const e=c?.name||`rgb(${t},${n},${o})`,i=c.premium?"★ ":"";a=`#${c.id} ${i}${e} • ${a}`}}catch(t){}}r.textContent=a;const c=document.createElement("input");c.type="checkbox",c.checked=!!n.enabled;try{c.dataset.rgb=e}catch(t){}c.addEventListener("change",()=>{n.enabled=c.checked,S.W(`${c.checked?"Enabled":"Disabled"} ${e}`);try{const t=document.querySelector("#bm-1h")?.value||document.querySelector("#bm-18")?.value,e=N.xt?.find(e=>e.et===t)||N.xt?.[0];e&&(e.Z=e.Z||{},(async()=>{try{N.gt||(N.gt=await N.$t()),N.gt.Ot[e.et]=N.gt.Ot[e.et]||{name:e.displayName||"",coords:(e.coords||[]).join(","),enabled:!0,Ct:{},palette:e.Z},N.gt.Ot[e.et].palette=e.Z;try{await GM.setValue("bmTemplates",JSON.stringify(N.gt))}catch(t){}window.postMessage({source:"blue-marble",zt:"bm-b"},"*")}catch(t){}})())}catch(t){}}),o.appendChild(c),o.appendChild(i),o.appendChild(r),t.appendChild(o)}},window.addEventListener("message",t=>{if("bm-b"===t?.data?.zt)try{const t=document.querySelector("#bm-9");if(t)try{t.style.display=""}catch(t){}setTimeout(()=>{try{"function"==typeof buildColorFilterList&&buildColorFilterList()}catch(t){}},50)}catch(t){}}),setTimeout(()=>{try{if(N.xt?.length>0){const t=document.querySelector("#bm-9");t&&(t.style.display="");try{document.querySelectorAll(".bm-1C, #bm-Z, #bm-Z").forEach(t=>t.style.display="flex")}catch(t){}try{if(!document.getElementById("bm-1o")){const t=document.createElement("style");t.id="bm-1o",t.textContent="\n  /* Force show minimize/maximize buttons (canonical + minified selectors) */\n  .bm-1-, #bm-2o, #bm-1_, .bm-1C, #bm-Z, #bm-27,\n  #bm-2a #bm-29, #bm-2a #bm-2g, #bm-2a #bm-2p {\n    display: flex !important;\n    visibility: visible !important;\n    align-items: center !important;\n    justify-content: center !important;\n  }\n\n  /* Equalize action buttons inside the header/container */\n  #bm-2a button, #bm-2a .bm-1x, .bm-1C, #bm-q, #bm-10, #bm-Z,\n  #bm-2a #bm-29 button, #bm-2a #bm-2g button, #bm-2a #bm-2p button {\n    width: 36px !important;\n    height: 36px !important;\n    min-width: 36px !important;\n    padding: 4px !important;\n    box-sizing: border-box !important;\n    display: inline-flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n  }\n\n  /* Make overlay/modal wider so coords inputs fit */\n  #bm-26, #bm-2a, .bm-A, #bm-A {\n    max-width: 520px !important;\n    width: 100% !important;\n  }\n\n  /* Coordinate inputs: cap width and prevent overflow */\n  #bm-2b, #bm-2c, #bm-2d, #bm-2e,\n  #bm-v, #bm-w, #bm-x, #bm-y {\n    max-width: 140px !important;\n    width: 140px !important;\n    box-sizing: border-box !important;\n    overflow: hidden !important;\n    white-space: nowrap !important;\n    text-overflow: ellipsis !important;\n  }\n\n  /* Neutralize host accent/background on header buttons inside #bm-2q */\n  #bm-2q button, #bm-2q .material-symbols-rounded, #bm-2q .btn {\n    background: transparent !important;\n    background-image: none !important;\n    background-color: transparent !important;\n    border: 0 !important;\n    border-color: transparent !important;\n    box-shadow: none !important;\n    -webkit-box-shadow: none !important;\n    outline: none !important;\n    filter: none !important;\n    color: inherit !important;\n  }\n  #bm-2q button::before, #bm-2q button::after, #bm-2q .material-symbols-rounded::before, #bm-2q .material-symbols-rounded::after {\n    content: none !important;\n    background: transparent !important;\n    box-shadow: none !important;\n    border: 0 !important;\n    height: 0 !important;\n    width: 0 !important;\n  }\n\n  /* Prevent the header buttons/containers from stretching */\n  #bm-2a > div, #bm-2a .bm-1R, #bm-k {\n    display: flex !important;\n    gap: 6px !important;\n    align-items: center !important;\n    flex-wrap: nowrap !important;\n  }\n\n  /* Reduce spacing only between the three small header buttons (minified and canonical ids)\n     Bring bm-29, bm-2g, bm-2p slightly closer without affecting other groups */\n  #bm-2a #bm-29, #bm-2a #bm-2g, #bm-2a #bm-2p,\n  html body #bm-29, html body #bm-2g, html body #bm-2p {\n    margin-right: 2px !important; /* small pull-in */\n  }\n  /* Remove extra right margin on the last of the three to avoid layout shift */\n  #bm-2a #bm-2p, html body #bm-2p {\n    margin-right: 0px !important;\n  }\n\n  /* Ensure material symbol icons render at a stable size */\n  .material-symbols-rounded {\n    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24 !important;\n    font-size: 20px !important;\n    line-height: 1 !important;\n  }\n\n  /* Hide empty container inside the color list (canonical + minified selectors) */\n  #bm-28 > div:empty, #bm-20 > div:empty {\n    display: none !important;\n    visibility: hidden !important;\n  }\n  ",document.head?.appendChild(t)}try{const t=()=>{try{["#bm-29","#bm-2g","#bm-2p",".bm-1C","#bm-Z","#bm-q","#bm-10"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("width","36px","important"),t.style.setProperty("height","36px","important"),t.style.setProperty("min-width","36px","important"),t.style.setProperty("padding","4px","important"),t.style.setProperty("box-sizing","border-box","important"),t.style.setProperty("align-items","center","important"),t.style.setProperty("justify-content","center","important")}catch(t){}})}),["#bm-2b","#bm-2c","#bm-2d","#bm-2e","#bm-v","#bm-w","#bm-x","#bm-y"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{t.style.setProperty("max-width","140px","important"),t.style.setProperty("width","140px","important"),t.style.setProperty("box-sizing","border-box","important"),t.style.setProperty("overflow","hidden","important")}catch(t){}})});const t=document.querySelector("#bm-2a")||document.querySelector("#bm-21")||document.querySelector("#bm-2a");if(t)try{t.style.setProperty("display","flex","important"),t.style.setProperty("gap","6px","important"),t.style.setProperty("align-items","center","important"),t.style.setProperty("flex-wrap","nowrap","important")}catch(t){}}catch(t){}};try{t()}catch(t){}const e=new MutationObserver(()=>{try{t()}catch(t){}});e.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{try{e.disconnect()}catch(t){}},4e3)}catch(t){}document.querySelectorAll(".bm-1-, #bm-2o, #bm-1_, .bm-1C, #bm-Z, #bm-27").forEach(t=>{try{t.style.display="flex",t.style.visibility="visible"}catch(t){}});try{setTimeout(()=>{["#bm-2r","#bm-2s","#bm-m","#bm-U"].forEach(t=>{try{const e=document.querySelector(t);if(!e)return;e.style.setProperty("background","transparent","important"),e.style.setProperty("background-color","transparent","important"),e.style.setProperty("border","0","important"),e.style.setProperty("box-shadow","none","important"),e.style.setProperty("outline","none","important")}catch(t){}})},40)}catch(t){}!function(){const t=["#bm-2r","#bm-2s","#bm-m","#bm-U"];function e(){try{t.forEach(t=>{try{const e=document.querySelector(t);if(!e)return;e.style.setProperty("background","transparent","important"),e.style.setProperty("background-color","transparent","important"),e.style.setProperty("background-image","none","important"),e.style.setProperty("border","0 solid transparent","important"),e.style.setProperty("border-color","transparent","important"),e.style.setProperty("box-shadow","none","important"),e.style.setProperty("-webkit-box-shadow","none","important"),e.style.setProperty("outline","none","important"),e.style.setProperty("filter","none","important"),e.style.setProperty("padding",e.style.padding||"4px","important");const n=e.querySelector&&e.querySelector(".material-symbols-rounded");if(n){try{n.style.setProperty("background","transparent","important")}catch(t){}try{n.style.setProperty("box-shadow","none","important")}catch(t){}try{n.style.setProperty("color","inherit","important")}catch(t){}}}catch(t){}})}catch(t){}}try{e()}catch(t){}let n=0;const o=setInterval(()=>{try{e(),n++,n>60&&clearInterval(o)}catch(t){}},200);try{const t=new MutationObserver(t=>{try{e()}catch(t){}});t.observe(document.body,{attributes:!0,subtree:!0,childList:!0,attributeFilter:["class","style"]}),setTimeout(()=>{try{t.disconnect()}catch(t){}},2e4)}catch(t){}}(),function(){try{const t="bm-N";if(document.getElementById(t))return;const e="\n                /* Target buttons inside the header div #bm-2q explicitly */\n                #bm-2q #bm-2r,\n                #bm-2q #bm-2s,\n                #bm-2q #bm-m,\n                #bm-2q #bm-U {\n                  background: transparent !important;\n                  background-image: none !important;\n                  background-color: transparent !important;\n                  border: 0 !important;\n                  border-color: transparent !important;\n                  box-shadow: none !important;\n                  -webkit-box-shadow: none !important;\n                  outline: none !important;\n                  filter: none !important;\n                }\n                /* Also neutralize pseudo-elements which host sites sometimes use to draw accents */\n                #bm-2q #bm-2r::before,\n                #bm-2q #bm-2r::after,\n                #bm-2q #bm-2s::before,\n                #bm-2q #bm-2s::after,\n                #bm-2q #bm-m::before,\n                #bm-2q #bm-m::after,\n                #bm-2q #bm-U::before,\n                #bm-2q #bm-U::after {\n                  background: transparent !important;\n                  background-image: none !important;\n                  box-shadow: none !important;\n                  border: 0 !important;\n                  outline: none !important;\n                  content: none !important;\n                  height: 0 !important;\n                  width: 0 !important;\n                }\n              ",n=document.createElement("style");n.id=t,n.textContent=e,(document.head||document.documentElement).appendChild(n)}catch(t){}}();try{const t=document.querySelector("#bm-m")||document.querySelector("#bm-2r")||document.querySelector('.bm-2t[title="Template Color Converter"]')||document.querySelector(".bm-2t");let e={width:"40px",height:"40px",padding:"6px",minWidth:"40px",boxSizing:"border-box"};if(t)try{const n=getComputedStyle(t);e={width:n.width||"40px",height:n.height||"40px",padding:n.padding||"6px",minWidth:n.minWidth||n.width||"40px",boxSizing:n.boxSizing||"border-box"}}catch(t){}document.querySelectorAll("#bm-29").forEach(t=>{try{t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),t.style.setProperty("width",e.width,"important"),t.style.setProperty("height",e.height,"important"),t.style.setProperty("min-width",e.minWidth,"important"),t.style.setProperty("padding",e.padding,"important"),t.style.setProperty("box-sizing",e.boxSizing,"important"),t.style.setProperty("align-items","center","important"),t.style.setProperty("justify-content","center","important")}catch(t){}})}catch(t){}}catch(t){}buildColorFilterList();try{window.buildTemplatePresetList()}catch(t){}}}catch(t){}},0),function(){try{void 0===window._bm_debugLock&&(window._bm_debugLock=!1)}catch(t){}let t=!1,e={ye:0,x:-9999,y:-9999,fe:!0};window.addEventListener("keydown",e=>{"Space"===e.code&&(t=!0)},!0),window.addEventListener("keyup",e=>{"Space"===e.code&&(t=!1)},!0);let n={ye:0,xe:[]};function o(t){const o=function(){if(Date.now()-n.ye<150&&n.xe&&n.xe.length)return n.xe.slice();const t=document.querySelectorAll('#bm-g input[type="checkbox"]'),e=[];if(t.forEach(t=>{try{t.checked&&t.dataset&&t.dataset.rgb&&e.push(t.dataset.rgb)}catch(t){}}),!e.length)try{const t=document.querySelector("#bm-18")?.value||document.querySelector("#bm-1h")?.value;let n=null;if(N&&Array.isArray(N.xt)&&N.xt.length>0&&(n=N.xt.find(e=>e.et===t)||N.xt[0]),n&&n.Z)for(const[t,o]of Object.entries(n.Z))try{o&&void 0!==o.enabled&&!o.enabled||e.push(t)}catch(t){}else if(N&&N.gt&&N.gt.Ot&&t&&N.gt.Ot[t]){const n=N.gt.Ot[t].palette||{};for(const t of Object.keys(n))try{const o=n[t];o&&void 0!==o.enabled&&!o.enabled||e.push(t)}catch(t){}}}catch(t){}n.ye=Date.now(),n.xe=e.slice(),n.ye=Date.now(),n.xe=e.slice();try{window._bm_debugLock&&console.debug("BM_DEBUG selectedRGBs",e.slice())}catch(t){}return e}();try{window._bm_debugLock&&console.debug("BM_DEBUG pointIsAllowedOnCanvas enter",{x:t.clientX,y:t.clientY,selected:o})}catch(t){}if(!o||!o.length)return!0;try{const n=Date.now(),o=Math.round(t.clientX),i=Math.round(t.clientY),r=n-(e.ye||0),a=Math.hypot(o-e.x,i-e.y);if(r<60&&a<6&&!0===e.fe){try{window._bm_debugLock&&console.debug("BM_DEBUG cache reuse positive",e)}catch(t){}return!0}}catch(t){}try{const n=N.kt();if(!n)return e={ye:Date.now(),x:Math.round(t.clientX),y:Math.round(t.clientY),fe:!1},!1;const i=n.getBoundingClientRect(),r=n.width/i.width,a=Math.floor((t.clientX-i.left)*r),c=Math.floor((t.clientY-i.top)*r),m=n.getContext("2d");if(!m)return e={ye:Date.now(),x:Math.round(t.clientX),y:Math.round(t.clientY),fe:!1},!1;try{const n=Number(N.ut)||3,i=1,r=Math.max(0,Math.floor((a-i)/n)*n+i),s=Math.max(0,Math.floor((c-i)/n)*n+i),l=m.getImageData(r,s,1,1).data,d=l[3];if(d<64)return e={ye:Date.now(),x:Math.round(t.clientX),y:Math.round(t.clientY),fe:!1},!1;const p=`${l[0]},${l[1]},${l[2]}`;let b=[];try{const t=document.querySelector("#bm-18")?.value||document.querySelector("#bm-1h")?.value;let e=null;N&&Array.isArray(N.xt)&&N.xt.length>0&&(e=N.xt.find(e=>e.et===t)||N.xt[0]),e&&e.Z&&(b=Object.keys(e.Z||{}))}catch(t){}const u=o.includes(p),h=o.includes("other")&&!b.includes(p),y=u||h;e={ye:Date.now(),x:Math.round(t.clientX),y:Math.round(t.clientY),fe:!!y};try{window._bm_debugLock&&console.debug("BM_DEBUG sampled",{Qt:a,ee:c,ge:r,we:s,ve:p,alpha:d,ke:y,selected:o,$e:b})}catch(t){}return!!y}catch(n){return e={ye:Date.now(),x:Math.round(t.clientX),y:Math.round(t.clientY),fe:!1},!1}}catch(n){e={ye:Date.now(),x:Math.round(t.clientX),y:Math.round(t.clientY),fe:!1};try{window._bm_debugLock&&console.debug("BM_DEBUG sample error",n)}catch(t){}return!1}}let i=null,r=!1;function a(){if(!r)try{const e=document.querySelector("div#map canvas.maplibregl-canvas")||document.querySelector("canvas.maplibregl-canvas")||document.querySelector("canvas");if(e){!function(e){if(!e)return;let n=null,i=null;const r=()=>{try{const t=["#bm-10","#bm-2k",".bm-1E"];return Array.from(document.querySelectorAll(t.join(","))).filter(Boolean).find(t=>t&&t.dataset&&"1"===t.dataset.locked)}catch(t){return null}},a=function(e){try{if(!r())return;if(!t)return;i=void 0!==e.pointerId?e.pointerId:null;const a=o(e);try{window._bm_debugLock&&console.debug("BM_DEBUG pointerdown",{id:e.pointerId,x:e.clientX,y:e.clientY,ke:a})}catch(t){}if(!a){try{S.W("Bloqueado: posición no coincide con un color seleccionado en la plantilla")}catch(t){}try{e.stopImmediatePropagation(),e.preventDefault()}catch(t){}return n=!1,!1}n=!0}catch(t){}},c=function(e){try{if(!r())return;if(!t)return;if(null!==i&&void 0!==e.pointerId&&e.pointerId!==i)return;const n=o(e);try{window._bm_debugLock&&console.debug("BM_DEBUG pointermove",{id:e.pointerId,x:e.clientX,y:e.clientY,ke:n})}catch(t){}if(!n){e.stopImmediatePropagation(),e.preventDefault();try{S.W("Bloqueado: posición no coincide con un color seleccionado en la plantilla")}catch(t){}return!1}}catch(t){}},m=function(t){try{n=null,i=null}catch(t){}};e.addEventListener("pointerdown",a,!0),e.addEventListener("pointermove",c,!0),e.addEventListener("pointerup",m,!0),e.addEventListener("pointercancel",m,!0),e.addEventListener("mousedown",a,!0),e.addEventListener("mousemove",c,!0),e.addEventListener("mouseup",m,!0)}(e),r=!0;try{c&&c.disconnect()}catch(t){}return}}catch(t){}}a();const c=new MutationObserver(()=>{clearTimeout(i),i=setTimeout(()=>{try{a()}catch(t){}},150)});c.observe(document.body,{childList:!0,subtree:!0})}()}();try{setTimeout(()=>{try{if("function"==typeof window.buildTemplatePresetList)try{window.buildTemplatePresetList()}catch(t){}try{window.postMessage({source:"blue-marble",zt:"bm-R"},"*")}catch(t){}}catch(t){}},60)}catch(t){}window.addEventListener("message",t=>{try{if("bm-R"===t?.data?.zt)try{!function(){try{const t=`Plantillas: ${(N.xt||[]).length||Object.keys(N.gt?.Ot||{}).length||0} (${(N.xt||[]).filter(t=>t&&!1!==t.enabled).length||Object.values(N.gt?.Ot||{}).filter(t=>t&&!1!==t.enabled).length||0} activas)`;try{const e=document.querySelector("#bm-X");e&&(e.textContent=t)}catch(t){}try{const e=document.querySelector("#bm-27");e&&(e.textContent=t)}catch(t){}}catch(t){}}()}catch(t){}}catch(t){}});try{const t=t=>{try{t&&0===t.childElementCount&&t.remove()}catch(t){}},e=document.getElementById("bm-28");t(e);const n=new MutationObserver((e,n)=>{try{const e=document.getElementById("bm-28");e&&t(e)}catch(t){}});n.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{try{n.disconnect()}catch(t){}},2e3)}catch(t){}S.L("#bm-A","#bm-z"),setTimeout(()=>{try{const t=document.querySelector("#bm-m")||document.querySelector("#bm-2r")||document.querySelector('.bm-D[title="Template Color Converter"]');if(!t)return;const e=getComputedStyle(t),n=(t,e)=>{try{if(!t||"string"!=typeof t)return e;if(t=t.trim(),/^\d+px$/.test(t))return t;const n=t.match(/(\d+(?:\.\d+)?)px/);if(n)return`${n[1]}px`}catch(t){}return e},o={width:n(e.width,""),height:n(e.height,"40px"),padding:e.padding||"6px",minWidth:n(e.minWidth||e.width,"40px"),boxSizing:e.boxSizing||"border-box"};["#bm-2g","#bm-2p","#bm-q","#bm-10"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{o.width&&(t.style.width=o.width),t.style.height=o.height,t.style.padding=o.padding,o.minWidth&&(t.style.minWidth=o.minWidth),t.style.boxSizing=o.boxSizing,t.style.display=t.style.display||"flex"}catch(t){}})}),["#bm-2g","#bm-2p","#bm-q","#bm-10",".bm-1V","#bm-29","#bm-1W","#bm-22","#bm-23"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{try{t.setAttribute("data-bm-1K","1")}catch(t){}t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),o.width&&t.style.setProperty("width",o.width,"important"),t.style.setProperty("height",o.height,"important"),t.style.setProperty("min-width",o.minWidth,"important"),t.style.setProperty("padding",o.padding,"important"),t.style.setProperty("box-sizing",o.boxSizing,"important");try{o.fontSize&&t.style.setProperty("font-size",o.fontSize,"important")}catch(t){}try{o.lineHeight&&t.style.setProperty("line-height",o.lineHeight,"important")}catch(t){}try{o.border&&t.style.setProperty("border",o.border,"important")}catch(t){}try{o.borderRadius&&t.style.setProperty("border-radius",o.borderRadius,"important")}catch(t){}t.style.setProperty("align-items","center","important"),t.style.setProperty("justify-content","center","important")}catch(t){}})});try{const t=document.querySelector("#bm-2g")||document.querySelector("#bm-q");let e="36px",n="36px",o="4px",i="36px",r="20px",a="1";if(t)try{const c=getComputedStyle(t),m=t=>t&&/\d+px/.test(t)?t.match(/(\d+(?:\.\d+)?)px/)[0]:null;e=m(c.width)||m(c.minWidth)||e,n=m(c.height)||n,o=c.padding||o,i=m(c.minWidth)||i,r=c.fontSize||r,a=c.lineHeight||a}catch(t){}document.querySelectorAll("#bm-29, #bm-Z").forEach(t=>{try{t.style.setProperty("width",e,"important"),t.style.setProperty("height",n,"important"),t.style.setProperty("min-width",i,"important"),t.style.setProperty("padding",o,"important"),t.style.setProperty("box-sizing","border-box","important"),t.style.setProperty("font-size",r,"important"),t.style.setProperty("line-height",a,"important"),t.style.setProperty("display","inline-flex","important"),t.style.setProperty("align-items","center","important"),t.style.setProperty("justify-content","center","important")}catch(t){}})}catch(t){}}catch(t){}},50);var z=!1;function D(){if(!z){z=!0;try{const t=document.querySelector("#bm-m")||document.querySelector("#bm-2r")||document.querySelector('.bm-D[title="Template Color Converter"]')||document.querySelector("#bm-2r"),e=t?getComputedStyle(t):null,n=t=>t&&/\d+px/.test(t)?t.match(/(\d+(?:\.\d+)?)px/)[0]:null,o={width:n(e?.width)||"",height:n(e?.height)||"40px",padding:e?.padding||"6px",minWidth:n(e?.minWidth||e?.width)||"40px",boxSizing:e?.boxSizing||"border-box",fontSize:e?.fontSize||"",lineHeight:e?.lineHeight||"",border:e?.border||"",borderRadius:e?.borderRadius||"",transition:e?.transition||"",willChange:e?.willChange||"",transformOrigin:e?.transformOrigin||""};["#bm-2g","#bm-2p","#bm-q","#bm-10",".bm-1V","#bm-29","#bm-1W","#bm-22","#bm-23"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{try{t.style.setProperty("display","flex","important"),t.style.setProperty("visibility","visible","important"),o.width&&t.style.setProperty("width",o.width,"important"),t.style.setProperty("height",o.height,"important"),t.style.setProperty("min-width",o.minWidth,"important"),t.style.setProperty("padding",o.padding,"important"),t.style.setProperty("box-sizing",o.boxSizing,"important");try{o.transition&&t.style.setProperty("transition",o.transition,"important")}catch(t){}try{o.willChange&&t.style.setProperty("will-change",o.willChange,"important")}catch(t){}try{o.transformOrigin&&t.style.setProperty("transform-origin",o.transformOrigin,"important")}catch(t){}try{o.fontSize&&t.style.setProperty("font-size",o.fontSize,"important")}catch(t){}try{o.lineHeight&&t.style.setProperty("line-height",o.lineHeight,"important")}catch(t){}try{o.border&&t.style.setProperty("border",o.border,"important")}catch(t){}try{o.borderRadius&&t.style.setProperty("border-radius",o.borderRadius,"important")}catch(t){}t.style.setProperty("align-items","center","important"),t.style.setProperty("justify-content","center","important");try{t.style.setProperty("transform","none","important")}catch(t){}try{t.style.setProperty("vertical-align","middle","important")}catch(t){}try{o.fontSize&&t.style.setProperty("font-size",o.fontSize,"important")}catch(t){}try{o.lineHeight&&t.style.setProperty("line-height",o.lineHeight,"important")}catch(t){}}catch(t){}})});const i=document.querySelector("#bm-2a"),r=document.querySelector("#bm-29")||document.querySelector("#bm-1W")||document.querySelector(".bm-1V")||document.querySelector("#bm-Z"),a=document.querySelector("#bm-2g")||document.querySelector("#bm-1X")||document.querySelector("#bm-q"),c=document.querySelector("#bm-2h")||document.querySelector("#bm-1Y")||document.querySelector("#bm-10");if(i&&r&&a)try{r.parentElement!==i&&i.insertBefore(r,a)}catch(t){try{r.parentElement!==i&&i.appendChild(r)}catch(t){}}if(i&&c&&a)try{c.parentElement!==i&&i.insertBefore(c,a.nextSibling)}catch(t){try{c.parentElement!==i&&i.appendChild(c)}catch(t){}}try{if(a){const t=getComputedStyle(a),e=t=>t&&/\d+px/.test(t)?t.match(/(\d+(?:\.\d+)?)px/)[0]:null,n={width:e(t.width)||e(t.minWidth)||o.width||"",height:e(t.height)||o.height||"",minWidth:e(t.minWidth)||o.minWidth||"",padding:t.padding||o.padding||"",boxSizing:t.boxSizing||o.boxSizing||"border-box",fontSize:t.fontSize||o.fontSize||"",lineHeight:t.lineHeight||o.lineHeight||"",transition:t.transition||o.transition||"",transform:t.transform||"",transformOrigin:t.transformOrigin||o.transformOrigin||"",verticalAlign:t.verticalAlign||"middle",display:t.display||"inline-flex",border:t.border||o.border||"",borderRadius:t.borderRadius||o.borderRadius||""};[r,c].forEach(t=>{if(t)try{n.width&&t.style.setProperty("width",n.width,"important"),n.height&&t.style.setProperty("height",n.height,"important"),n.minWidth&&t.style.setProperty("min-width",n.minWidth,"important"),n.padding&&t.style.setProperty("padding",n.padding,"important"),t.style.setProperty("box-sizing",n.boxSizing,"important"),n.fontSize&&t.style.setProperty("font-size",n.fontSize,"important"),n.lineHeight&&t.style.setProperty("line-height",n.lineHeight,"important"),n.transition&&t.style.setProperty("transition",n.transition,"important"),n.transform&&t.style.setProperty("transform",n.transform,"important"),n.transformOrigin&&t.style.setProperty("transform-origin",n.transformOrigin,"important"),n.verticalAlign&&t.style.setProperty("vertical-align",n.verticalAlign,"important"),n.display&&t.style.setProperty("display",n.display,"important"),n.border&&t.style.setProperty("border",n.border,"important"),n.borderRadius&&t.style.setProperty("border-radius",n.borderRadius,"important"),t.style.setProperty("align-items","center","important"),t.style.setProperty("justify-content","center","important"),t.style.setProperty("margin","0px","important")}catch(t){}});try{n.width&&a.style.setProperty("width",n.width,"important"),n.height&&a.style.setProperty("height",n.height,"important"),n.transition&&a.style.setProperty("transition",n.transition,"important"),n.transform&&a.style.setProperty("transform",n.transform,"important")}catch(t){}}}catch(t){}i&&i.style&&i.style.setProperty&&i.style.setProperty("gap","2px","important")}catch(t){}try{setTimeout(()=>{z=!1},0)}catch(t){z=!1}}}try{D(),new MutationObserver(()=>{z||D()}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]});const t=setInterval(()=>{z||D()},2e3);setTimeout(()=>{try{clearInterval(t)}catch(t){}},1e4)}catch(t){}function G(){if(document.querySelector("#bm-Y"))return;const t=document.createElement("div");t.id="bm-Y",t.style.display="none",t.className="bm-1S";const e=document.createElement("div");e.className="bm-1p";const n=document.createElement("h3");n.textContent="Editar posición de plantilla",e.appendChild(n);const o=document.createElement("div");o.className="bm-1z",["Tl X","Tl Y","Px X","Px Y"].forEach((t,e)=>{const n=document.createElement("div");n.style.display="flex",n.style.gap="6px",n.style.marginBottom="6px";const i=document.createElement("label");i.textContent=t,i.style.width="60px";const r=document.createElement("input");r.type="number",r.id=`bm-1t${e}`,r.style.flex="1",n.appendChild(i),n.appendChild(r),o.appendChild(n)});const i=document.createElement("div");i.style.display="flex",i.style.gap="8px",i.style.marginTop="8px";const r=document.createElement("button");r.className="btn btn-soft",r.textContent="Guardar";const a=document.createElement("button");a.className="btn btn-soft",a.textContent="Cancelar",i.appendChild(r),i.appendChild(a),e.appendChild(o),e.appendChild(i),t.appendChild(e),document.body.appendChild(t);let c=null;a.addEventListener("click",()=>{t.style.display="none",c=null}),r.addEventListener("click",()=>{try{const t=[0,1,2,3].map(t=>Number(document.querySelector(`#bm-1t${t}`).value||0));if(t.some(t=>isNaN(t)))return void alert("Coordenadas inválidas");c&&N.gt?.Ot&&N.gt.Ot[c]&&(N.gt.Ot[c].coords=t.join(","),GM.setValue("bmTemplates",JSON.stringify(N.gt)),window.postMessage({source:"blue-marble",zt:"bm-R"},"*"),S.W(`Coords actualizadas: ${t.join(",")}`))}catch(t){S.I("Error guardando coordenadas")}t.style.display="none",c=null}),window.openEditTemplateModal=function(e){G(),c=e;const n=N.gt?.Ot?.[e],o=(n?.coords||"").split(",").map(t=>Number(t)||0);for(let t=0;t<4;t++)document.querySelector(`#bm-1t${t}`).value=o[t]||0;t.style.display="flex"}}O.Ht(S),new MutationObserver((t,e)=>{const n=document.querySelector("#color-1");if(!n)return;let o=document.querySelector("#bm-t");if(!o){o=document.createElement("button"),o.id="bm-t",o.textContent="Mover ↑",o.className="btn btn-soft",o.onclick=function(){const t=this.parentNode.parentNode.parentNode.parentNode,e="Move ↑"==this.textContent;t.parentNode.className=t.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),t.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",t.style.borderTopRightRadius=e?"0px":"var(--radius-box)",t.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",t.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move ↓":"Move ↑"};const t=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");t.parentNode?.appendChild(o)}}).observe(document.body,{childList:!0,subtree:!0}),function(...t){(0,console.log)(...t)}(`%c${$}%c (${M}) userscript has loaded!`,"color: cornflowerblue;",""),setTimeout(()=>{try{G()}catch(t){}},200),window.buildTemplatePresetList=function(){let t=document.querySelector("#bm-1s")||document.querySelector("#bm-24");if(!t){const e=document.querySelector("#bm-2u")||document.querySelector("#bm-28")||document.querySelector("#bm-2v");if(!e)return;t=document.createElement("div"),t.id="bm-1s",t.style.marginTop="12px",t.style.setProperty("display","block","important"),t.style.maxHeight="220px",t.style.overflow="auto",e.appendChild(t)}t.innerHTML="";const e=N.xt||[];try{console.log("BM: buildTemplatePresetList called",{Ot:(e||[]).length,containerId:t.id,Me:getComputedStyle(t).display})}catch(t){}if(e.length)try{t.style.setProperty("display","block","important")}catch(e){try{t.style.display=""}catch(t){}}if(!e.length){try{t.style.setProperty("display","none","important")}catch(e){t.style.display="none"}const e=document.querySelector("#bm-X"),n=document.querySelector("#bm-27"),o="Plantillas: 0 (0 activas)";try{e&&(e.textContent=o)}catch(t){}try{n&&(n.textContent=o)}catch(t){}return}try{const t=N.gt?.Ot||{};e.forEach(e=>{try{t[e.et]&&void 0!==t[e.et].selected&&(e.selected=!!t[e.et].selected)}catch(t){}})}catch(t){}try{const t=document.querySelector("#bm-18"),e=N.gt?.Ot||{},n=Object.keys(e).find(t=>e[t]&&e[t].selected);if(n&&t){try{t.value=n}catch(t){}try{const t=document.querySelector("#bm-9");t&&(t.style.display="")}catch(t){}try{"function"==typeof buildColorFilterList&&buildColorFilterList()}catch(t){}}}catch(t){}const n=document.createElement("div");n.id="bm-17",n.style.display="flex",n.style.flexDirection="column",n.style.gap="6px",n.style.marginTop="6px",t.appendChild(n);const o=document.createElement("div");o.style.display="flex",o.style.gap="6px",o.style.marginTop="8px";const i=document.createElement("button");i.className="btn btn-soft",i.textContent="Activar todas";try{i.style.setProperty("display","inline-flex","important"),i.style.setProperty("flex","1 1 0","important"),i.style.setProperty("min-width","0","important"),i.style.setProperty("box-sizing","border-box","important"),i.style.setProperty("padding","6px 12px","important"),i.style.setProperty("font-size","12px","important"),i.style.setProperty("height","40px","important"),i.style.removeProperty("width"),i.style.removeProperty("max-width")}catch(t){}i.addEventListener("click",()=>{e.forEach(t=>{t.enabled=!0;try{N.gt?.Ot&&t.et&&(N.gt.Ot[t.et].enabled=!0)}catch(t){}});try{GM.setValue("bmTemplates",JSON.stringify(N.gt))}catch(t){}window.postMessage({source:"blue-marble",zt:"bm-R"},"*"),S.W("Activadas todas las plantillas")});const r=document.createElement("button");r.className="btn btn-soft",r.textContent="Desactivar todas";try{r.style.setProperty("display","inline-flex","important"),r.style.setProperty("flex","1 1 0","important"),r.style.setProperty("min-width","0","important"),r.style.setProperty("box-sizing","border-box","important"),r.style.setProperty("padding","6px 12px","important"),r.style.setProperty("font-size","12px","important"),r.style.setProperty("height","40px","important"),r.style.removeProperty("width"),r.style.removeProperty("max-width")}catch(t){}r.addEventListener("click",()=>{try{const t=document.querySelector("#bm-18")?.value,e=N.xt||[];let n=null;if(t&&(n=e.find(e=>e&&e.et===t)||null),n||(n=e.find(t=>t&&t.selected)||null),!n){const t=N.gt?.Ot||{},o=Object.keys(t).find(e=>t[e]&&t[e].selected);o&&(n=e.find(t=>t&&t.et===o)||null)}if(!n)return void S.I("No hay plantilla seleccionada");if(n.Z){Object.values(n.Z).forEach(t=>{t&&(t.enabled=!1)});try{N.gt?.Ot&&n.et&&(N.gt.Ot[n.et]=N.gt.Ot[n.et]||{},N.gt.Ot[n.et].palette=n.Z,GM.setValue("bmTemplates",JSON.stringify(N.gt)))}catch(t){}}else try{N.gt?.Ot&&n.et&&N.gt.Ot[n.et]?.palette&&(Object.values(N.gt.Ot[n.et].palette).forEach(t=>{t&&(t.enabled=!1)}),GM.setValue("bmTemplates",JSON.stringify(N.gt)))}catch(t){}try{buildColorFilterList()}catch(t){}S.W("Colores desactivados (plantilla seleccionada)"),console.log("BM: disable-all applied to active template",n?.et||"(unknown)")}catch(t){console.error("BM disable-all error",t)}}),o.appendChild(i),o.appendChild(r),t.appendChild(o),e.forEach(e=>{try{const t=N.gt?.Ot?.[e.et];t&&void 0!==t.enabled&&(e.enabled=!!t.enabled)}catch(t){}const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="space-between",n.style.gap="8px",n.style.marginTop="6px";const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.gap="8px",o.style.flex="1 1 0",o.style.minWidth="0";const i=document.createElement("input");i.type="checkbox",i.checked=!!e.enabled,i.addEventListener("change",()=>{e.enabled=i.checked;try{N.gt?.Ot&&e.et&&(N.gt.Ot[e.et].enabled=!!e.enabled,GM.setValue("bmTemplates",JSON.stringify(N.gt)),window.postMessage({source:"blue-marble",zt:"bm-b"},"*"),window.postMessage({source:"blue-marble",zt:"bm-R"},"*"))}catch(t){}S.W(`${i.checked?"Enabled":"Disabled"} ${e.displayName}`)});const r=document.createElement("span");r.style.fontSize="12px",r.style.flex="1 1 0",r.style.minWidth="0",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.whiteSpace="nowrap",r.textContent=e.displayName||e.et,o.appendChild(i),o.appendChild(r),n.appendChild(o);const a=document.createElement("div");a.style.display="flex",a.style.gap="6px",a.style.alignItems="center",a.style.flex="0 0 auto";const c=document.createElement("button");c.className="btn btn-soft bm-1w",c.innerHTML='<span class="material-symbols-rounded">radio_button_unchecked</span>';try{c.style.setProperty("display","inline-flex","important"),c.style.setProperty("flex","0 0 auto","important"),c.style.setProperty("width","auto","important"),c.style.setProperty("max-width","40px","important"),c.style.setProperty("min-width","34px","important"),c.style.setProperty("height","30px","important"),c.style.setProperty("padding","4px","important"),c.style.setProperty("margin","0","important"),c.style.setProperty("box-sizing","border-box","important")}catch(t){}if(c.addEventListener("click",()=>{try{if(e.selected||N.gt?.Ot?.[e.et]&&N.gt.Ot[e.et].selected){try{const t=document.querySelector("#bm-9");t&&(t.style.display="")}catch(t){}try{"function"==typeof buildColorFilterList&&buildColorFilterList()}catch(t){}return}Object.values(N.gt?.Ot||{}).forEach(t=>{t&&(t.selected=!1)}),e.et&&N.gt?.Ot&&N.gt.Ot[e.et]&&(N.gt.Ot[e.et].selected=!0,GM.setValue("bmTemplates",JSON.stringify(N.gt))),(N.xt||[]).forEach(t=>t.selected=t.et===e.et);try{const t=document.querySelector("#bm-18");t&&(t.value=e.et)}catch(t){}try{const t=document.querySelector("#bm-9");t&&(t.style.display="")}catch(t){}try{"function"==typeof buildColorFilterList&&buildColorFilterList()}catch(t){}try{document.querySelectorAll("#bm-1s .bm-1w").forEach(t=>{try{const e=t.querySelector(".material-symbols-rounded");if(e){e.textContent="radio_button_unchecked";try{e.style.setProperty("color","","important")}catch(t){}}try{t.style.setProperty("background","transparent","important")}catch(t){}try{t.style.removeProperty("box-shadow")}catch(t){}}catch(t){}});const t=c.querySelector(".material-symbols-rounded");if(t){t.textContent="radio_button_checked";try{t.style.setProperty("color","#0078d7","important")}catch(t){}}try{c.style.setProperty("background","rgba(0,120,215,0.14)","important")}catch(t){}try{c.style.setProperty("box-shadow","inset 0 0 0 1px rgba(0,0,0,0.08)","important")}catch(t){}}catch(t){}try{window.postMessage({source:"blue-marble",zt:"bm-R"},"*")}catch(t){}}catch(t){}}),e.selected||N.gt?.Ot?.[e.et]&&N.gt.Ot[e.et].selected){try{c.style.setProperty("background","rgba(0,120,215,0.14)","important")}catch(t){}try{c.style.setProperty("box-shadow","inset 0 0 0 1px rgba(0,0,0,0.08)","important")}catch(t){}try{const t=c.querySelector(".material-symbols-rounded");t&&(t.textContent="radio_button_checked",t.style.setProperty("color","#0078d7","important"))}catch(t){}}const m=document.createElement("button");m.className="btn btn-soft bm-1q",m.title="Eliminar plantilla",m.innerHTML='<span class="material-symbols-rounded">delete</span>';try{m.style.setProperty("display","inline-flex","important"),m.style.setProperty("flex","0 0 auto","important"),m.style.setProperty("width","auto","important"),m.style.setProperty("max-width","40px","important"),m.style.setProperty("min-width","34px","important"),m.style.setProperty("height","30px","important"),m.style.setProperty("padding","4px","important"),m.style.setProperty("margin","0","important"),m.style.setProperty("box-sizing","border-box","important")}catch(t){}a.appendChild(c),a.appendChild(m),n.appendChild(a),m.addEventListener("click",async()=>{if(confirm(`Eliminar plantilla "${e.displayName||e.et}"? Esta acción no se puede deshacer.`))try{await N.Gt(e.et),S.W(`Plantilla eliminada: ${e.displayName}`)}catch(t){S.I("Error eliminando plantilla")}}),t.appendChild(n)});try{const t=N.gt?.Ot||{},n=`Plantillas: ${e&&e.length||Object.keys(t).length||0} (${e&&e.filter(t=>t&&!1!==t.enabled).length||Object.values(t).filter(t=>t&&!1!==t.enabled).length||0} activas)`;try{const t=document.querySelector("#bm-X");t&&(t.textContent=n)}catch(t){}try{const t=document.querySelector("#bm-27");t&&(t.textContent=n)}catch(t){}}catch(t){}},window.addEventListener("message",t=>{if("bm-R"===t?.data?.zt)try{window.buildTemplatePresetList()}catch(t){}})})();