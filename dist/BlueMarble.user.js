// ==UserScript==
// @name         Black Marble
// @namespace    https://github.com/Jaie55/
// @version      0.85.2
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The project icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       Raw Community
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://bluemarble.lol/
// @icon         https://i.imgur.com/qP3QpF9.png
// @updateURL    https://raw.githubusercontent.com/Jaie55/Wplace-BlueMarble/main/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/Jaie55/Wplace-BlueMarble/main/dist/BlueMarble.user.js
// @match        https://wplace.live/*
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      telemetry.thebluecorner.net
// @resource     CSS-BM-File https://raw.githubusercontent.com/Jaie55/Wplace-BlueMarble/main/dist/BlueMarble.user.css
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{function t(){if(document.querySelector("#bm-I"))return;const e=document.createElement("div");e.id="bm-I",e.style.display="none",e.className="bm-S";const a=document.createElement("div");a.className="bm-O";const n=document.createElement("h3");n.textContent="Editar posición de plantilla",a.appendChild(n);const o=document.createElement("div");o.className="bm-R",["Tl X","Tl Y","Px X","Px Y"].forEach((t,e)=>{const a=document.createElement("div");a.style.display="flex",a.style.gap="6px",a.style.marginBottom="6px";const n=document.createElement("label");n.textContent=t,n.style.width="60px";const l=document.createElement("input");l.type="number",l.id=`bm-P${e}`,l.style.flex="1",a.appendChild(n),a.appendChild(l),o.appendChild(a)});const l=document.createElement("div");l.style.display="flex",l.style.gap="8px",l.style.marginTop="8px";const c=document.createElement("button");c.className="btn btn-soft",c.textContent="Guardar";const i=document.createElement("button");i.className="btn btn-soft",i.textContent="Cancelar",l.appendChild(c),l.appendChild(i),a.appendChild(o),a.appendChild(l),e.appendChild(a),document.body.appendChild(e);let r=null;i.addEventListener("click",()=>{e.style.display="none",r=null}),c.addEventListener("click",()=>{try{const t=[0,1,2,3].map(t=>Number(document.querySelector(`#bm-P${t}`).value||0));if(t.some(t=>isNaN(t)))return void alert("Coordenadas inválidas");r&&templateManager.templatesJSON?.templates&&templateManager.templatesJSON.templates[r]&&(templateManager.templatesJSON.templates[r].coords=t.join(","),GM.setValue("bmTemplates",JSON.stringify(templateManager.templatesJSON)),window.postMessage({source:"blue-marble",t:"bm-H"},"*"),overlayMain.handleDisplayStatus(`Coords actualizadas: ${t.join(",")}`))}catch(t){overlayMain.handleDisplayError("Error guardando coordenadas")}e.style.display="none",r=null}),window.openEditTemplateModal=function(a){t(),r=a;const n=templateManager.templatesJSON?.templates?.[a],o=(n?.coords||"").split(",").map(t=>Number(t)||0);for(let t=0;t<4;t++)document.querySelector(`#bm-P${t}`).value=o[t]||0;e.style.display="flex"}}GM_info.script.name.toString(),GM_info.script.version.toString(),setTimeout(()=>{try{t()}catch(t){}},200),window.buildTemplatePresetList=function(){const t=document.querySelector("#bm-Q");if(!t)return;t.innerHTML="";const e=templateManager.templatesArray||[];if(!e.length){t.style.display="none";const e=document.querySelector("#bm-J");return void(e&&(e.textContent="Plantillas: 0 (0 activas)"))}t.style.display="";const a=document.createElement("div");a.id="bm-M",a.style.display="flex",a.style.flexDirection="column",a.style.gap="6px",a.style.marginTop="6px",t.appendChild(a);const n=document.createElement("div");n.style.display="flex",n.style.gap="6px",n.style.marginTop="8px";const o=document.createElement("button");o.className="btn btn-soft",o.textContent="Activar todas",o.addEventListener("click",()=>{e.forEach(t=>{t.enabled=!0;try{templateManager.templatesJSON?.templates&&t.o&&(templateManager.templatesJSON.templates[t.o].enabled=!0)}catch(t){}});try{GM.setValue("bmTemplates",JSON.stringify(templateManager.templatesJSON))}catch(t){}window.postMessage({source:"blue-marble",t:"bm-H"},"*"),overlayMain.handleDisplayStatus("Activadas todas las plantillas")});const l=document.createElement("button");l.className="btn btn-soft",l.textContent="Desactivar todas",l.addEventListener("click",()=>{e.forEach(t=>{t.enabled=!1;try{templateManager.templatesJSON?.templates&&t.o&&(templateManager.templatesJSON.templates[t.o].enabled=!1)}catch(t){}});try{GM.setValue("bmTemplates",JSON.stringify(templateManager.templatesJSON))}catch(t){}window.postMessage({source:"blue-marble",t:"bm-H"},"*"),overlayMain.handleDisplayStatus("Desactivadas todas las plantillas")}),n.appendChild(o),n.appendChild(l),t.appendChild(n),e.forEach(e=>{try{const t=templateManager.templatesJSON?.templates?.[e.o];t&&void 0!==t.enabled&&(e.enabled=!!t.enabled)}catch(t){}const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.gap="8px",a.style.marginTop="6px";const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.gap="8px";const o=document.createElement("input");o.type="checkbox",o.checked=!!e.enabled,o.addEventListener("change",()=>{e.enabled=o.checked;try{templateManager.templatesJSON?.templates&&e.o&&(templateManager.templatesJSON.templates[e.o].enabled=!!e.enabled,GM.setValue("bmTemplates",JSON.stringify(templateManager.templatesJSON)),window.postMessage({source:"blue-marble",t:"bm-b"},"*"),window.postMessage({source:"blue-marble",t:"bm-H"},"*"))}catch(t){}overlayMain.handleDisplayStatus(`${o.checked?"Enabled":"Disabled"} ${e.displayName}`)});const l=document.createElement("span");l.style.fontSize="12px",l.textContent=e.displayName||e.o,n.appendChild(o),n.appendChild(l),a.appendChild(n);const c=document.createElement("button");c.className="btn btn-soft",c.textContent=e.enabled?"Ocultar":"Mostrar",c.addEventListener("click",()=>{e.enabled=!e.enabled;try{templateManager.templatesJSON?.templates&&e.o&&(templateManager.templatesJSON.templates[e.o].enabled=!!e.enabled,GM.setValue("bmTemplates",JSON.stringify(templateManager.templatesJSON)))}catch(t){}c.textContent=e.enabled?"Ocultar":"Mostrar",window.postMessage({source:"blue-marble",t:"bm-H"},"*"),overlayMain.handleDisplayStatus(`${e.enabled?"Mostrando":"Ocultando"} ${e.displayName}`)}),a.appendChild(c);const i=document.createElement("button");i.className="btn btn-soft",i.textContent="Abrir",i.addEventListener("click",()=>{try{const t=document.querySelector("#bm-N");t&&(t.value=e.o||"");const a=document.querySelector("#bm-9");a&&(a.style.display="");try{window.postMessage({source:"blue-marble",t:"bm-b"},"*")}catch(t){}overlayMain.handleDisplayStatus(`Abriendo plantilla ${e.displayName}`)}catch(t){overlayMain.handleDisplayError("No se pudo abrir la plantilla")}}),a.appendChild(i);const r=document.createElement("div");r.style.display="none",r.style.gap="6px";const m=document.createElement("button");m.className="btn btn-soft",m.textContent="Editar posición",m.addEventListener("click",()=>{try{window.openEditTemplateModal(e.o)}catch(t){alert("No se pudo abrir el editor")}});const d=document.createElement("button");d.className="btn btn-danger",d.textContent="Eliminar",d.addEventListener("click",async()=>{if(confirm(`Eliminar plantilla "${e.displayName||e.o}"? Esta acción no se puede deshacer.`))try{await templateManager.deleteTemplate(e.o),overlayMain.handleDisplayStatus(`Plantilla eliminada: ${e.displayName}`)}catch(t){overlayMain.handleDisplayError("Error eliminando plantilla")}}),r.appendChild(m),r.appendChild(d),l.style.cursor="pointer",l.addEventListener("click",()=>{r.style.display="none"===r.style.display?"flex":"none"}),a.appendChild(r);const s=document.createElement("button");s.className="btn btn-danger",s.textContent="Eliminar",s.addEventListener("click",async()=>{if(confirm(`Eliminar plantilla "${e.displayName||e.o}"? Esta acción no se puede deshacer.`))try{await templateManager.deleteTemplate(e.o),overlayMain.handleDisplayStatus(`Plantilla eliminada: ${e.displayName}`)}catch(t){overlayMain.handleDisplayError("Error eliminando plantilla")}}),a.appendChild(s),t.appendChild(a)});try{const t=document.querySelector("#bm-J");if(t){const a=e.length,n=e.filter(t=>t&&!1!==t.enabled).length;t.textContent=`Plantillas: ${a} (${n} activas)`}}catch(t){}},window.addEventListener("message",t=>{if("bm-H"===t?.data?.t)try{window.buildTemplatePresetList()}catch(t){}})})();